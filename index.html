<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Japanese Numbers & Counters Quiz</title>
    <style>
        body {
            font-family: 'Hiragino Kaku Gothic ProN', 'ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ ProN W3', 'Meiryo', 'ãƒ¡ã‚¤ãƒªã‚ª', 'Osaka', 'MS PGothic', 'ï¼­ï¼³ ï¼°ã‚´ã‚·ãƒƒã‚¯', 'Arial', sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f4f1ea;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            color: #333;
        }

        .top-controls {
            display: flex;
            gap: 15px; /* Space between toggle buttons */
            margin-bottom: 20px;
            align-items: center;
        }

        .control-button { /* Common class for top control buttons */
            background-color: #8b5e3c;
            color: #f4f1ea;
            border: none;
            padding: 10px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease, transform 0.1s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .control-button:hover {
            background-color: #7a5230;
        }
        .control-button:active {
            transform: translateY(1px);
        }
        #playSoundButton {
            background-color: #5a8b3c; /* A different color for play sound */
            margin-top: 10px; /* Spacing from feedback */
            padding: 10px 15px;
            font-size: 1em;
        }
        #playSoundButton:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }


        .quiz-container {
            background-color: #ffffff;
            padding: 35px 40px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            width: 100%;
            max-width: 550px;
            text-align: center;
        }

        h1 {
            color: #4a4a4a;
            margin-bottom: 30px;
            font-size: 2em;
            font-weight: 600;
        }

        #questionArea {
            font-size: 2.8em;
            color: #2c5282;
            margin-bottom: 30px;
            padding: 20px;
            background-color: #e6f0f7;
            border-radius: 10px;
            min-height: 70px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
        }

        #answerInput {
            width: calc(100% - 24px);
            padding: 15px;
            margin-bottom: 25px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 1.2em;
            box-sizing: border-box;
            color: #333;
        }
        #answerInput::placeholder {
            color: #9ca3af;
        }

        .buttons-group {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        button.quiz-button {
            color: white;
            border: none;
            padding: 14px 22px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 500;
            transition: background-color 0.3s ease, transform 0.1s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button.quiz-button:hover {
            opacity: 0.9;
        }
        button.quiz-button:active {
            transform: translateY(1px);
        }

        #checkButton {
            background-color: #38a169;
        }
        #checkButton:hover {
            background-color: #2f855a;
        }

        #nextButton {
            background-color: #3182ce;
        }
        #nextButton:hover {
            background-color: #2b6cb0;
        }

        #feedbackArea {
            margin-top: 25px;
            font-size: 1.15em;
            min-height: 35px;
            font-weight: 600;
        }

        .correct {
            color: #38a169;
        }

        .incorrect {
            color: #e53e3e;
        }

        #scoreArea {
            margin-top: 30px;
            font-size: 1.25em;
            color: #555;
            font-weight: 500;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 600px) {
            .quiz-container {
                padding: 25px 20px;
            }
            h1 {
                font-size: 1.6em;
            }
            #questionArea {
                font-size: 2.2em;
                padding: 15px;
                min-height: 60px;
            }
            #answerInput, button.quiz-button {
                font-size: 1em;
                padding: 12px 18px;
            }
            .control-button, #playSoundButton {
                font-size: 0.8em;
                padding: 8px 15px;
            }
        }
    </style>
</head>
<body>
    <div class="top-controls">
        <button id="languageToggle" class="control-button">åˆ‡æ¢è¯­è¨€ (Switch Language)</button>
        <button id="muteToggle" class="control-button">é™éŸ³</button>
    </div>

    <div class="quiz-container">
        <h1 id="uiTitle">æ—¥è¯­æ•°å­—å’Œé‡è¯ç»ƒä¹ </h1>
        <div id="questionArea"></div>
        <input type="text" id="answerInput" placeholder="è¯·è¾“å…¥è¯»éŸ³ (å¹³å‡å)">
        <div class="buttons-group">
            <button id="checkButton" class="quiz-button">æ£€æŸ¥ç­”æ¡ˆ</button>
            <button id="nextButton" class="quiz-button">ä¸‹ä¸€ä¸ª</button>
        </div>
        <div id="feedbackArea"></div>
        <button id="playSoundButton" class="control-button" disabled>æ’­æ”¾å£°éŸ³</button>
        <div id="scoreArea"><span id="uiScoreLabel">åˆ†æ•°</span>: <span id="score">0</span></div>
    </div>

    <script>
        // --- UI Text Strings for Localization ---
        const uiStrings = {
            zh: {
                htmlLang: 'zh-CN',
                title: 'æ—¥è¯­æ•°å­—å’Œé‡è¯ç»ƒä¹ ',
                checkAnswer: 'æ£€æŸ¥ç­”æ¡ˆ',
                nextQuestion: 'ä¸‹ä¸€ä¸ª',
                scoreLabel: 'åˆ†æ•°',
                placeholder: 'è¯·è¾“å…¥è¯»éŸ³ (å¹³å‡å)',
                correctFeedback: 'æ­£ç¡®ï¼ ğŸ‰',
                incorrectFeedbackPrefix: 'é”™è¯¯ã€‚æ­£ç¡®ç­”æ¡ˆæ˜¯: ',
                inputPrompt: 'è¯·è¾“å…¥ç­”æ¡ˆï¼',
                toggleButton: 'åˆ‡æ¢è‡³ English',
                pageTitle: 'æ—¥è¯­æ•°å­—å’Œé‡è¯ç»ƒä¹ ',
                mute: 'é™éŸ³',
                unmute: 'å–æ¶ˆé™éŸ³',
                playSound: 'æ’­æ”¾å£°éŸ³'
            },
            en: {
                htmlLang: 'en',
                title: 'Japanese Numbers & Counters Quiz',
                checkAnswer: 'Check Answer',
                nextQuestion: 'Next',
                scoreLabel: 'Score',
                placeholder: 'Enter reading (Hiragana)',
                correctFeedback: 'Correct! ğŸ‰',
                incorrectFeedbackPrefix: 'Incorrect. The correct answer is: ',
                inputPrompt: 'Please enter an answer!',
                toggleButton: 'åˆ‡æ¢è‡³ ä¸­æ–‡',
                pageTitle: 'Japanese Quiz',
                mute: 'Mute',
                unmute: 'Unmute',
                playSound: 'Play Sound'
            }
        };
        let currentLanguage = 'zh';
        let isMuted = false;
        const synth = window.speechSynthesis; // Speech Synthesis API

        // --- DOM Elements for UI Text & Controls ---
        const htmlElement = document.documentElement;
        const pageTitleElement = document.querySelector('title');
        const uiTitleElement = document.getElementById('uiTitle');
        const answerInputElement = document.getElementById('answerInput');
        const checkButtonElement = document.getElementById('checkButton');
        const nextButtonElement = document.getElementById('nextButton');
        const uiScoreLabelElement = document.getElementById('uiScoreLabel');
        const languageToggleButton = document.getElementById('languageToggle');
        const muteToggleButton = document.getElementById('muteToggle');
        const playSoundButton = document.getElementById('playSoundButton');


        function updateUIText() {
            const strings = uiStrings[currentLanguage];
            htmlElement.lang = strings.htmlLang;
            pageTitleElement.textContent = strings.pageTitle;
            uiTitleElement.textContent = strings.title;
            answerInputElement.placeholder = strings.placeholder;
            checkButtonElement.textContent = strings.checkAnswer;
            nextButtonElement.textContent = strings.nextQuestion;
            uiScoreLabelElement.textContent = strings.scoreLabel;
            languageToggleButton.textContent = strings.toggleButton;
            muteToggleButton.textContent = isMuted ? strings.unmute : strings.mute;
            playSoundButton.textContent = strings.playSound;
        }

        function setInitialLanguage() {
            const browserLang = (navigator.language || navigator.userLanguage || 'zh').toLowerCase();
            if (browserLang.startsWith('en')) {
                currentLanguage = 'en';
            } else {
                currentLanguage = 'zh';
            }
            updateUIText();
        }

        // --- Speech Synthesis Function ---
        function speak(textToSpeak) {
            if (isMuted || !textToSpeak || !synth) {
                return;
            }
            if (synth.speaking) { // If already speaking, cancel previous and speak new
                synth.cancel();
            }
            const utterance = new SpeechSynthesisUtterance(textToSpeak);
            utterance.lang = 'ja-JP'; // Specify Japanese language
            utterance.rate = 0.9; // Slightly slower for clarity
            utterance.pitch = 1;

            // Attempt to find a Japanese voice
            const voices = synth.getVoices();
            const japaneseVoice = voices.find(voice => voice.lang === 'ja-JP');
            if (japaneseVoice) {
                utterance.voice = japaneseVoice;
            } else {
                console.warn("No Japanese voice found, using default.");
            }
            synth.speak(utterance);
        }
        // Ensure voices are loaded (some browsers load them asynchronously)
        if (synth.onvoiceschanged !== undefined) {
            synth.onvoiceschanged = () => {
                // Voices loaded, could re-call speak if something was pending
                // For this app, it's usually fine as speak is called on demand
            };
        }


        languageToggleButton.addEventListener('click', () => {
            currentLanguage = (currentLanguage === 'zh') ? 'en' : 'zh';
            updateUIText();
            if (feedbackArea.textContent && currentQuestionData) {
                const isCurrentlyCorrect = feedbackArea.classList.contains('correct');
                const tempAnswer = currentQuestionData.a;
                if (isCurrentlyCorrect) {
                     feedbackArea.textContent = uiStrings[currentLanguage].correctFeedback;
                     if (currentQuestionData.type === 'complex_number' && currentQuestionData.kanji_representation) {
                        feedbackArea.textContent += ` (${currentQuestionData.kanji_representation})`;
                     }
                } else {
                    let correctAnswerText = `${uiStrings[currentLanguage].incorrectFeedbackPrefix}${tempAnswer}`;
                    if (currentQuestionData.type === 'complex_number' && currentQuestionData.kanji_representation) {
                        correctAnswerText += ` ( ${currentQuestionData.kanji_representation} )`;
                    }
                    feedbackArea.textContent = correctAnswerText;
                }
            }
        });

        muteToggleButton.addEventListener('click', () => {
            isMuted = !isMuted;
            muteToggleButton.textContent = isMuted ? uiStrings[currentLanguage].unmute : uiStrings[currentLanguage].mute;
            if (isMuted && synth.speaking) {
                synth.cancel(); // Stop any current speech if muted
            }
        });

        playSoundButton.addEventListener('click', () => {
            if (currentQuestionData && currentQuestionData.a) {
                speak(currentQuestionData.a);
            }
        });


        // --- Japanese Content Data (Unchanged) ---
        const singleDigitReadings = { '1': 'ã„ã¡', '2': 'ã«', '3': 'ã•ã‚“', '4': 'ã‚ˆã‚“', '5': 'ã”', '6': 'ã‚ã', '7': 'ãªãª', '8': 'ã¯ã¡', '9': 'ãã‚…ã†', '0': '' };
        const singleDigitKanji = { '0': 'é›¶', '1': 'ä¸€', '2': 'äºŒ', '3': 'ä¸‰', '4': 'å››', '5': 'äº”', '6': 'å…­', '7': 'ä¸ƒ', '8': 'å…«', '9': 'ä¹' };

        function numToJapaneseSimple(num_to_convert) {
            if (num_to_convert === 0) return { kanji: "", reading: "" };
            if (num_to_convert > 9999 || num_to_convert < 0) { return {kanji: String(num_to_convert), reading: String(num_to_convert)}; }
            let n = num_to_convert; let k = ""; let r = "";
            if (n >= 1000) {
                const th = Math.floor(n / 1000);
                if (th === 1) { k += "åƒ"; r += "ã›ã‚“"; }
                else { k += (singleDigitKanji[String(th)] || String(th)) + "åƒ";
                    if (th === 3) r += "ã•ã‚“ãœã‚“"; else if (th === 8) r += "ã¯ã£ã›ã‚“";
                    else r += (singleDigitReadings[String(th)] || String(th)) + "ã›ã‚“"; }
                n %= 1000;
            }
            if (n >= 100) {
                const h = Math.floor(n / 100);
                if (h === 1) { k += "ç™¾"; r += "ã²ã‚ƒã"; }
                else { k += (singleDigitKanji[String(h)] || String(h)) + "ç™¾";
                    if (h === 3) r += "ã•ã‚“ã³ã‚ƒã"; else if (h === 6) r += "ã‚ã£ã´ã‚ƒã"; else if (h === 8) r += "ã¯ã£ã´ã‚ƒã";
                    else r += (singleDigitReadings[String(h)] || String(h)) + "ã²ã‚ƒã"; }
                n %= 100;
            }
            if (n >= 10) {
                const t = Math.floor(n / 10);
                if (t === 1) { k += "å"; r += "ã˜ã‚…ã†"; }
                else { k += (singleDigitKanji[String(t)] || String(t)) + "å";
                       r += (singleDigitReadings[String(t)] || String(t)) + "ã˜ã‚…ã†"; }
                n %= 10;
            }
            if (n > 0) { k += singleDigitKanji[String(n)] || String(n); r += singleDigitReadings[String(n)] || String(n); }
            return { kanji: k, reading: r };
        }

        function numToJapanese(num_orig) {
            if (num_orig === 0) return { kanji: "é›¶", reading: "ã‚Œã„" };
            if (num_orig > 99999999 || num_orig < 0) { return {kanji: String(num_orig) + "(è½¬æ¢è¶…å‡ºèŒƒå›´)", reading: String(num_orig) + "(è½¬æ¢è¶…å‡ºèŒƒå›´)"}; }
            let num = num_orig; let k = ""; let r = "";
            if (num >= 10000) {
                const manVal = Math.floor(num / 10000); const manParts = numToJapaneseSimple(manVal);
                k += manParts.kanji + "ä¸‡"; r += manParts.reading + "ã¾ã‚“";
                num %= 10000; if (num === 0) return { kanji: k, reading: r };
            }
            if (num > 0 || k === "") { const restParts = numToJapaneseSimple(num); k += restParts.kanji; r += restParts.reading; }
            if (k === "" && r === "" && num_orig > 0) { return {kanji: String(num_orig), reading: String(num_orig)}; }
            return { kanji: k, reading: r };
        }

        const quizData = [
            { type: 'standalone_number', unit: 'ç™¾', values: [ { num: 100, q: 'ç™¾', a: 'ã²ã‚ƒã' }, { num: 200, q: 'äºŒç™¾', a: 'ã«ã²ã‚ƒã' }, { num: 300, q: 'ä¸‰ç™¾', a: 'ã•ã‚“ã³ã‚ƒã' }, { num: 400, q: 'å››ç™¾', a: 'ã‚ˆã‚“ã²ã‚ƒã' }, { num: 500, q: 'äº”ç™¾', a: 'ã”ã²ã‚ƒã' }, { num: 600, q: 'å…­ç™¾', a: 'ã‚ã£ã´ã‚ƒã' }, { num: 700, q: 'ä¸ƒç™¾', a: 'ãªãªã²ã‚ƒã' }, { num: 800, q: 'å…«ç™¾', a: 'ã¯ã£ã´ã‚ƒã' }, { num: 900, q: 'ä¹ç™¾', a: 'ãã‚…ã†ã²ã‚ƒã' } ]},
            { type: 'standalone_number', unit: 'åƒ', values: [ { num: 1000, q: 'åƒ', a: 'ã›ã‚“' }, { num: 2000, q: 'äºŒåƒ', a: 'ã«ã›ã‚“' }, { num: 3000, q: 'ä¸‰åƒ', a: 'ã•ã‚“ãœã‚“' }, { num: 4000, q: 'å››åƒ', a: 'ã‚ˆã‚“ã›ã‚“' }, { num: 5000, q: 'äº”åƒ', a: 'ã”ã›ã‚“' }, { num: 6000, q: 'å…­åƒ', a: 'ã‚ãã›ã‚“' }, { num: 7000, q: 'ä¸ƒåƒ', a: 'ãªãªã›ã‚“' }, { num: 8000, q: 'å…«åƒ', a: 'ã¯ã£ã›ã‚“' }, { num: 9000, q: 'ä¹åƒ', a: 'ãã‚…ã†ã›ã‚“' } ]},
            { type: 'complex_number', displayName: 'å¤æ‚æ•°å­—', range: [101, 99999], generator: function() { let num; do { num = getRandomInt(this.range[0], this.range[1]); } while ( (num < 1000 && num % 100 === 0) || (num < 10000 && num % 1000 === 0) ); const jp = numToJapanese(num); return { q: String(num), a: jp.reading, kanji_representation: jp.kanji }; } },
            { type: 'number_counter_list', counterKanji: 'æœˆ', items: [ { num: 1, numKanji: 'ä¸€', qSuffix: 'æœˆ', a: 'ã„ã¡ãŒã¤' }, { num: 2, numKanji: 'äºŒ', qSuffix: 'æœˆ', a: 'ã«ãŒã¤' }, { num: 3, numKanji: 'ä¸‰', qSuffix: 'æœˆ', a: 'ã•ã‚“ãŒã¤' }, { num: 4, numKanji: 'å››', qSuffix: 'æœˆ', a: 'ã—ãŒã¤' }, { num: 5, numKanji: 'äº”', qSuffix: 'æœˆ', a: 'ã”ãŒã¤' }, { num: 6, numKanji: 'å…­', qSuffix: 'æœˆ', a: 'ã‚ããŒã¤' }, { num: 7, numKanji: 'ä¸ƒ', qSuffix: 'æœˆ', a: 'ã—ã¡ãŒã¤' }, { num: 8, numKanji: 'å…«', qSuffix: 'æœˆ', a: 'ã¯ã¡ãŒã¤' }, { num: 9, numKanji: 'ä¹', qSuffix: 'æœˆ', a: 'ããŒã¤' }, { num: 10, numKanji: 'å', qSuffix: 'æœˆ', a: 'ã˜ã‚…ã†ãŒã¤' }, { num: 11, numKanji: 'åä¸€', qSuffix: 'æœˆ', a: 'ã˜ã‚…ã†ã„ã¡ãŒã¤' }, { num: 12, numKanji: 'åäºŒ', qSuffix: 'æœˆ', a: 'ã˜ã‚…ã†ã«ãŒã¤' } ]},
            { type: 'number_counter_list', counterKanji: 'æ—¥', items: [ { num: 1, numKanji: 'ä¸€', qSuffix: 'æ—¥', a: 'ã¤ã„ãŸã¡' }, { num: 2, numKanji: 'äºŒ', qSuffix: 'æ—¥', a: 'ãµã¤ã‹' }, { num: 3, numKanji: 'ä¸‰', qSuffix: 'æ—¥', a: 'ã¿ã£ã‹' }, { num: 4, numKanji: 'å››', qSuffix: 'æ—¥', a: 'ã‚ˆã£ã‹' }, { num: 5, numKanji: 'äº”', qSuffix: 'æ—¥', a: 'ã„ã¤ã‹' }, { num: 6, numKanji: 'å…­', qSuffix: 'æ—¥', a: 'ã‚€ã„ã‹' }, { num: 7, numKanji: 'ä¸ƒ', qSuffix: 'æ—¥', a: 'ãªã®ã‹' }, { num: 8, numKanji: 'å…«', qSuffix: 'æ—¥', a: 'ã‚ˆã†ã‹' }, { num: 9, numKanji: 'ä¹', qSuffix: 'æ—¥', a: 'ã“ã“ã®ã‹' }, { num: 10, numKanji: 'å', qSuffix: 'æ—¥', a: 'ã¨ãŠã‹' }, { num: 11, numKanji: 'åä¸€', qSuffix: 'æ—¥', a: 'ã˜ã‚…ã†ã„ã¡ã«ã¡'}, {num: 12, numKanji: 'åäºŒ', qSuffix: 'æ—¥', a: 'ã˜ã‚…ã†ã«ã«ã¡'}, { num: 13, numKanji: 'åä¸‰', qSuffix: 'æ—¥', a: 'ã˜ã‚…ã†ã•ã‚“ã«ã¡'}, { num: 14, numKanji: 'åå››', qSuffix: 'æ—¥', a: 'ã˜ã‚…ã†ã‚ˆã£ã‹' }, {num: 15, numKanji: 'åäº”', qSuffix: 'æ—¥', a: 'ã˜ã‚…ã†ã”ã«ã¡'}, { num: 16, numKanji: 'åå…­', qSuffix: 'æ—¥', a: 'ã˜ã‚…ã†ã‚ãã«ã¡'}, {num: 17, numKanji: 'åä¸ƒ', qSuffix: 'æ—¥', a: 'ã˜ã‚…ã†ã—ã¡ã«ã¡'}, {num: 18, numKanji: 'åå…«', qSuffix: 'æ—¥', a: 'ã˜ã‚…ã†ã¯ã¡ã«ã¡'}, {num: 19, numKanji: 'åä¹', qSuffix: 'æ—¥', a: 'ã˜ã‚…ã†ãã«ã¡'}, { num: 20, numKanji: 'äºŒå', qSuffix: 'æ—¥', a: 'ã¯ã¤ã‹' }, { num: 21, numKanji: 'äºŒåä¸€', qSuffix: 'æ—¥', a: 'ã«ã˜ã‚…ã†ã„ã¡ã«ã¡'}, { num: 24, numKanji: 'äºŒåå››', qSuffix: 'æ—¥', a: 'ã«ã˜ã‚…ã†ã‚ˆã£ã‹' } ]},
            { type: 'number_counter_generated', counterKanji: 'æ™‚', range: [1, 12], generator: (num) => { const { kanji: k, reading: r } = numToJapaneseSimple(num); let a = ''; if (num === 4) a = 'ã‚ˆã˜'; else if (num === 7) a = 'ã—ã¡ã˜'; else if (num === 9) a = 'ãã˜'; else a = r + 'ã˜'; return { q: k + 'æ™‚', a: a }; }},
            { type: 'number_counter_generated', counterKanji: 'åˆ†', range: [1, 59], generator: (num) => { const { kanji: k, reading: r } = numToJapaneseSimple(num); let a = ''; const ld = num % 10; if (num === 1) a = 'ã„ã£ã·ã‚“'; else if (num === 3 || (num > 10 && ld === 3)) a = r.slice(0, r.length - singleDigitReadings['3'].length) + 'ã•ã‚“ã·ã‚“'; else if (num === 4 || (num > 10 && ld === 4)) a = r.slice(0, r.length - singleDigitReadings['4'].length) + 'ã‚ˆã‚“ã·ã‚“'; else if (num === 6 || (num > 10 && ld === 6)) a = r.slice(0, r.length - singleDigitReadings['6'].length) + 'ã‚ã£ã·ã‚“'; else if (num === 8 || (num > 10 && ld === 8)) a = r.slice(0, r.length - singleDigitReadings['8'].length) + 'ã¯ã£ã·ã‚“'; else if (num % 10 === 0) { if (num === 10) a = 'ã˜ã‚…ã£ã·ã‚“'; else a = r.slice(0, -3) + 'ã£ã·ã‚“'; } else if (num > 10 && ld === 1) a = r.slice(0, r.length - singleDigitReadings['1'].length) + 'ã„ã£ã·ã‚“'; else a = r + 'ãµã‚“'; if (num === 10) a = 'ã˜ã‚…ã£ã·ã‚“'; if (num === 20) a = 'ã«ã˜ã£ã·ã‚“'; if (num === 30) a = 'ã•ã‚“ã˜ã£ã·ã‚“'; if (num === 40) a = 'ã‚ˆã‚“ã˜ã£ã·ã‚“'; if (num === 50) a = 'ã”ã˜ã£ã·ã‚“'; return { q: k + 'åˆ†', a: a }; }},
            { type: 'number_counter_generated', counterKanji: 'å›', range: [1, 20], generator: (num) => { const { kanji: k, reading: r } = numToJapaneseSimple(num); let a = ''; if (num === 1) a = 'ã„ã£ã‹ã„'; else if (num === 6) a = 'ã‚ã£ã‹ã„'; else if (num === 8) a = 'ã¯ã£ã‹ã„'; else if (num === 10) a = 'ã˜ã£ã‹ã„'; else if (num > 10 && num % 10 === 1) a = r.slice(0, r.length - singleDigitReadings['1'].length) + 'ã„ã£ã‹ã„'; else if (num > 10 && num % 10 === 6) a = r.slice(0, r.length - singleDigitReadings['6'].length) + 'ã‚ã£ã‹ã„'; else if (num > 10 && num % 10 === 8) a = r.slice(0, r.length - singleDigitReadings['8'].length) + 'ã¯ã£ã‹ã„'; else if (num > 10 && num % 10 === 0) a = r.slice(0,-3) + 'ã£ã‹ã„'; else a = r + 'ã‹ã„'; return { q: k + 'å›', a: a }; }},
            { type: 'number_counter_generated', counterKanji: 'å†Š', range: [1, 20], generator: (num) => { const { kanji: k, reading: r } = numToJapaneseSimple(num); let a = ''; if (num === 1) a = 'ã„ã£ã•ã¤'; else if (num === 8) a = 'ã¯ã£ã•ã¤'; else if (num === 10) a = 'ã˜ã£ã•ã¤'; else if (num > 10 && num % 10 === 1) a = r.slice(0, r.length - singleDigitReadings['1'].length) + 'ã„ã£ã•ã¤'; else if (num > 10 && num % 10 === 8) a = r.slice(0, r.length - singleDigitReadings['8'].length) + 'ã¯ã£ã•ã¤'; else if (num > 10 && num % 10 === 0) a = r.slice(0,-3) + 'ã£ã•ã¤'; else a = r + 'ã•ã¤'; return { q: k + 'å†Š', a: a }; }},
            { type: 'number_counter_generated', counterKanji: 'ç€', range: [1, 10], generator: (num) => { const { kanji: k, reading: r } = numToJapaneseSimple(num); let a = ''; if (num === 1) a = 'ã„ã£ã¡ã‚ƒã'; else if (num === 8) a = 'ã¯ã£ã¡ã‚ƒã'; else if (num === 10) a = 'ã˜ã£ã¡ã‚ƒã'; else a = r + 'ã¡ã‚ƒã'; return { q: k + 'ç€', a: a }; }},
            { type: 'number_counter_generated', counterKanji: 'æš', range: [1, 20], generator: (num) => { const { kanji: k, reading: r } = numToJapaneseSimple(num); return { q: k + 'æš', a: r + 'ã¾ã„' }; }},
            { type: 'number_counter_generated', counterKanji: 'äºº', range: [1, 10], generator: (num) => { const { kanji: k, reading: r } = numToJapaneseSimple(num); let a = ''; if (num === 1) a = 'ã²ã¨ã‚Š'; else if (num === 2) a = 'ãµãŸã‚Š'; else if (num === 4) a = 'ã‚ˆã«ã‚“'; else a = r + 'ã«ã‚“'; return { q: k + 'äºº', a: a }; }},
        ];

        const questionArea = document.getElementById('questionArea');
        const answerInput = document.getElementById('answerInput');
        const checkButton = document.getElementById('checkButton');
        const nextButton = document.getElementById('nextButton');
        const feedbackArea = document.getElementById('feedbackArea');
        const scoreDisplay = document.getElementById('score');

        let currentQuestionData = null;
        let score = 0;

        function getRandomInt(min, max) {
            min = Math.ceil(min); max = Math.floor(max);
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function generateQuestion() {
            answerInput.value = ''; feedbackArea.textContent = ''; feedbackArea.className = '';
            answerInput.disabled = false; checkButton.disabled = false;
            playSoundButton.disabled = true; // Disable play sound until answer is checked

            const catIdx = getRandomInt(0, quizData.length - 1); const cat = quizData[catIdx];

            if (cat.type === 'standalone_number' || cat.type === 'number_counter_list') {
                const items = cat.values || cat.items; const itemIdx = getRandomInt(0, items.length - 1);
                currentQuestionData = { q: items[itemIdx].q, a: items[itemIdx].a, type: cat.type };
                if (cat.type === 'number_counter_list') { currentQuestionData.q = items[itemIdx].numKanji + items[itemIdx].qSuffix; }
            } else if (cat.type === 'number_counter_generated' || cat.type === 'complex_number') {
                const numGen = (cat.type === 'complex_number') ? null : getRandomInt(cat.range[0], cat.range[1]);
                currentQuestionData = cat.generator(numGen);
                currentQuestionData.type = cat.type;
            }
            questionArea.textContent = currentQuestionData.q;
        }

        function checkAnswer() {
            const userAnswer = answerInput.value.trim().replace(/ã‚”/g, 'ã†ã‚›');
            const strings = uiStrings[currentLanguage];

            if (!userAnswer) {
                feedbackArea.textContent = strings.inputPrompt; feedbackArea.className = 'incorrect';
                return;
            }

            if (userAnswer === currentQuestionData.a) {
                feedbackArea.textContent = strings.correctFeedback;
                if (currentQuestionData.type === 'complex_number' && currentQuestionData.kanji_representation) {
                    feedbackArea.textContent += ` (${currentQuestionData.kanji_representation})`;
                }
                feedbackArea.className = 'correct'; score++; scoreDisplay.textContent = score;
            } else {
                let correctAnswerText = `${strings.incorrectFeedbackPrefix}${currentQuestionData.a}`;
                if (currentQuestionData.type === 'complex_number' && currentQuestionData.kanji_representation) {
                    correctAnswerText += ` ( ${currentQuestionData.kanji_representation} )`;
                }
                feedbackArea.textContent = correctAnswerText; feedbackArea.className = 'incorrect';
            }
            answerInput.disabled = true; checkButton.disabled = true;
            playSoundButton.disabled = false; // Enable play sound button
        }

        checkButton.addEventListener('click', checkAnswer);
        nextButton.addEventListener('click', generateQuestion);
        answerInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                if (!checkButton.disabled) { checkAnswer(); }
                else { generateQuestion(); }
            }
        });

        setInitialLanguage();
        generateQuestion();
    </script>
</body>
</html>
