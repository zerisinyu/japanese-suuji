<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Japanese Numbers & Counters Quiz</title>
    <style>
        :root {
            --primary-color: #4A90E2; /* A modern blue */
            --secondary-color: #50E3C2; /* A vibrant teal/mint */
            --accent-color: #F5A623; /* An accent orange for highlights */
            --background-color: #f8f9fa; /* Even lighter background */
            --card-background-color: #ffffff;
            --text-color: #212529; /* Darker text for better contrast */
            --text-light-color: #495057;
            --border-color: #dee2e6;
            --success-color: #28a745; 
            --error-color: #dc3545;   
            --button-text-color: #ffffff;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';
            --input-focus-shadow: rgba(74, 144, 226, 0.25);
        }

        body {
            font-family: var(--font-family);
            display: flex;
            flex-direction: column;
            justify-content: flex-start; 
            align-items: center;
            min-height: 100vh;
            background-color: var(--background-color);
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            color: var(--text-color);
        }

        .top-controls-container {
            width: 100%;
            max-width: 600px; 
            margin-bottom: 25px;
        }

        .top-controls {
            display: flex;
            flex-wrap: wrap; 
            justify-content: center; 
            gap: 10px; 
            align-items: center;
            padding: 10px;
            background-color: var(--card-background-color);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.07);
        }

        .control-button, .mode-selector select {
            background-color: var(--card-background-color);
            color: var(--primary-color);
            border: 1px solid var(--border-color);
            padding: 8px 15px; 
            border-radius: 18px; 
            cursor: pointer;
            font-size: 0.85em; 
            font-weight: 500;
            transition: background-color 0.2s ease, color 0.2s ease, box-shadow 0.2s ease, transform 0.1s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            height: 36px; 
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            flex-grow: 1; 
            flex-basis: auto; 
            display: inline-flex; /* Added for better centering with text-align */
            align-items: center; /* Vertically center content */
            justify-content: center; /* Horizontally center content */
            text-align: center; 
        }

        .mode-selector select {
             background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%234A90E2%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.4-12.8z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 9px; 
            padding-right: 30px; /* Make space for arrow */
            padding-left: 15px; /* Ensure text isn't cramped */
            text-align-last: center; /* For select specifically */
        }
         /* Firefox specific for select text centering */
        @-moz-document url-prefix() {
            .mode-selector select {
                text-align-last: center;
            }
        }


        .control-button:hover, .mode-selector select:hover {
            background-color: var(--primary-color);
            color: var(--button-text-color);
            border-color: var(--primary-color);
            box-shadow: 0 3px 8px rgba(74, 144, 226, 0.2);
        }
         .control-button:hover.mode-selector select, .mode-selector select:hover { 
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23FFFFFF%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.4-12.8z%22%2F%3E%3C%2Fsvg%3E');
        }
        .control-button:active {
            transform: translateY(1px);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        #muteToggle.muted, #listeningModeToggle.active {
            background-color: var(--secondary-color);
            color: var(--button-text-color); 
            border-color: var(--secondary-color);
        }
         #muteToggle.muted:hover, #listeningModeToggle.active:hover {
            background-color: #45D1B5; 
        }


        .mode-selector { display: flex; align-items: center; flex-grow: 1; flex-basis: auto; } 

        #playSoundButton {
            background-color: var(--accent-color); 
            color: var(--button-text-color);
            border: none; margin-top: 15px; padding: 12px 20px;
            font-size: 1em; font-weight: 500; border-radius: 20px;
            display: inline-flex; /* For centering content */
            align-items: center;
            justify-content: center;
        }
        #playSoundButton:disabled {
            background-color: #e0e0e0; color: #9e9e9e;
            cursor: not-allowed; box-shadow: none;
        }
         #playSoundButton:hover:not(:disabled) {
            background-color: #F39C12; 
            box-shadow: 0 4px 10px rgba(245, 166, 35, 0.2);
        }

        .quiz-container {
            background-color: var(--card-background-color);
            padding: 30px 35px; border-radius: 16px; 
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08); 
            width: 100%; max-width: 600px; text-align: center;
        }

        h1 {
            color: var(--text-color); margin-bottom: 30px;
            font-size: 2em; font-weight: 700; 
        }

        #questionArea {
            font-size: 2.8em; color: var(--primary-color); margin-bottom: 30px;
            padding: 20px; background-color: #e9f2ff; 
            border-radius: 12px; min-height: 75px;
            display: flex; justify-content: center; align-items: center;
            font-weight: 700; line-height: 1.3;
        }
        #questionArea.listening-prompt {
            font-size: 1.5em; color: var(--secondary-color);
            background-color: #e0f8f2; 
        }

        #answerInput {
            width: calc(100% - 24px); padding: 15px; margin-bottom: 25px; 
            border: 1px solid var(--border-color); border-radius: 8px; 
            font-size: 1.2em; box-sizing: border-box; color: var(--text-color);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        #answerInput:focus {
            outline: none; border-color: var(--primary-color);
            box-shadow: 0 0 0 3px var(--input-focus-shadow);
        }
        #answerInput::placeholder { color: #adb5bd; } 

        .buttons-group { display: flex; justify-content: center; gap: 15px; } 

        button.quiz-button {
            color: var(--button-text-color); border: none;
            padding: 14px 22px; border-radius: 22px; 
            cursor: pointer; font-size: 1.1em; font-weight: 600;
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            min-width: 130px; 
        }
        button.quiz-button:hover {
             box-shadow: 0 5px 10px rgba(0,0,0,0.12);
             transform: translateY(-1px);
        }
        button.quiz-button:active {
            transform: translateY(0px);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        #checkButton { background-color: var(--success-color); }
        #checkButton:hover { background-color: #218838; } 
        #nextButton { background-color: var(--primary-color); }
        #nextButton:hover { background-color: #3A7BC8; }

        #feedbackArea { margin-top: 25px; font-size: 1.15em; min-height: 38px; font-weight: 600; }
        .correct { color: var(--success-color); }
        .incorrect { color: var(--error-color); }
        #scoreArea { margin-top: 30px; font-size: 1.25em; color: var(--text-light-color); font-weight: 500; }

        @media (max-width: 768px) { 
            .control-button, .mode-selector, .mode-selector select {
                flex-basis: calc(50% - 6px); 
                min-width: 140px; /* Adjusted min-width */
            }
        }

        @media (max-width: 480px) { 
            .top-controls { gap: 8px; }
            .control-button, .mode-selector select {
                font-size: 0.8em; padding: 8px 12px; height: 34px;
                flex-basis: calc(50% - 4px); /* Try for 2 per row even on small screens */
                min-width: 120px; /* Further reduce min-width */
            }
            .mode-selector { flex-basis: calc(50% - 4px); } /* Ensure div also takes 50% */
            .mode-selector select { width: 100%; padding-right: 25px; background-size: 8px; }

            .quiz-container { padding: 25px 15px; }
            h1 { font-size: 1.6em; margin-bottom: 25px; }
            #questionArea { font-size: 2.2em; padding: 15px; min-height: 65px; margin-bottom: 25px;}
            #questionArea.listening-prompt { font-size: 1.3em; }
            #answerInput { font-size: 1.1em; padding: 12px; margin-bottom: 20px;}
            button.quiz-button { font-size: 1em; padding: 12px 18px; min-width: 100px; }
            .buttons-group { gap: 10px; }
            #feedbackArea { font-size: 1.1em; margin-top: 20px; }
            #scoreArea { font-size: 1.15em; margin-top: 25px; }
            #playSoundButton { font-size: 0.9em; padding: 10px 15px; }
        }
    </style>
</head>
<body>
    <div class="top-controls-container">
        <div class="top-controls">
            <button id="languageToggle" class="control-button">åˆ‡æ¢è¯­è¨€</button>
            <button id="muteToggle" class="control-button">é™éŸ³</button>
            <div class="mode-selector">
                <select id="quizModeSelect" class="control-button">
                    <option value="all" id="uiQuizModeAll">å…¨éƒ¨</option>
                    <option value="numbers_only" id="uiQuizModeNumbersOnly" selected>ä»…æ•°å­—</option>
                    <option value="counters_datetime" id="uiQuizModeCountersDateTime">æ—¥æœŸä¸æ—¶é—´</option>
                    <option value="counters_objects" id="uiQuizModeCountersObjects">ç‰©å“é‡è¯</option>
                    <option value="counters_living" id="uiQuizModeCountersLiving">äººä¸åŠ¨ç‰©</option>
                </select>
            </div>
            <button id="listeningModeToggle" class="control-button">å¬å†™æ¨¡å¼</button>
        </div>
    </div>

    <div class="quiz-container">
        <h1 id="uiTitle">æ—¥è¯­æ•°å­—å’Œé‡è¯ç»ƒä¹ </h1>
        <div id="questionArea"></div>
        <input type="text" id="answerInput" placeholder="è¯·è¾“å…¥è¯»éŸ³ (å¹³å‡å/Romaji)">
        <div class="buttons-group">
            <button id="checkButton" class="quiz-button">æ£€æŸ¥ç­”æ¡ˆ</button>
            <button id="nextButton" class="quiz-button">ä¸‹ä¸€ä¸ª</button>
        </div>
        <div id="feedbackArea"></div>
        <button id="playSoundButton" class="control-button" disabled>æ’­æ”¾å£°éŸ³</button>
        <div id="scoreArea"><span id="uiScoreLabel">åˆ†æ•°</span>: <span id="score">0</span></div>
    </div>

    <script>
        const uiStrings = {
            zh: {
                htmlLang: 'zh-CN', title: 'æ—¥è¯­ç»ƒä¹ ', checkAnswer: 'æ£€æŸ¥', nextQuestion: 'ä¸‹ä¸€ä¸ª',
                scoreLabel: 'å¾—åˆ†', placeholderDefault: 'è¾“å…¥è¯»éŸ³ (å¹³å‡å/Romaji)', placeholderListening: 'è¯·å†™å…¥å¬åˆ°çš„å†…å®¹',
                correctFeedback: 'æ­£ç¡®! ğŸ‰', incorrectFeedbackPrefix: 'é”™è¯¯ã€‚æ­£ç¡®: ', inputPrompt: 'è¯·è¾“å…¥ç­”æ¡ˆï¼',
                toggleButton: 'English', pageTitle: 'æ—¥è¯­ç»ƒä¹ ', mute: 'é™éŸ³', unmute: 'å–æ¶ˆé™éŸ³',
                playSound: 'æ’­æ”¾', 
                quizModeAll: 'å…¨éƒ¨', quizModeNumbersOnly: 'æ•°å­—', quizModeCountersDateTime: 'æ—¥æœŸ/æ—¶é—´',
                quizModeCountersObjects: 'ç‰©å“', quizModeCountersLiving: 'äºº/åŠ¨ç‰©',
                listeningModeOn: 'è§†è§‰æ¨¡å¼', listeningModeOff: 'å¬å†™æ¨¡å¼',
                listeningPrompt: 'è¯·å¬å£°éŸ³...'
            },
            en: {
                htmlLang: 'en', title: 'Japanese Quiz', checkAnswer: 'Check', nextQuestion: 'Next',
                scoreLabel: 'Score', placeholderDefault: 'Enter reading (Hiragana/Romaji)', placeholderListening: 'Write what you hear',
                correctFeedback: 'Correct! ğŸ‰', incorrectFeedbackPrefix: 'Incorrect. Correct: ', inputPrompt: 'Please enter an answer!',
                toggleButton: 'ä¸­æ–‡', pageTitle: 'Japanese Quiz', mute: 'Mute', unmute: 'Unmute',
                playSound: 'Play', 
                quizModeAll: 'All', quizModeNumbersOnly: 'Numbers', quizModeCountersDateTime: 'Dates/Time',
                quizModeCountersObjects: 'Objects', quizModeCountersLiving: 'People/Animals',
                listeningModeOn: 'Visual Mode', listeningModeOff: 'Listening Mode',
                listeningPrompt: 'Listen to the audio...'
            }
        };
        let currentLanguage = 'zh';
        let isMuted = false;
        const synth = window.speechSynthesis;
        let currentQuizMode = 'numbers_only'; 
        let isListeningMode = false;

        // --- Romaji Conversion (Basic with sokuon and some long vowels) ---
        const romajiMonographs = {
            ã‚:'a', ã„:'i', ã†:'u', ãˆ:'e', ãŠ:'o',
            ã‹:'ka', ã:'ki', ã:'ku', ã‘:'ke', ã“:'ko',
            ã•:'sa', ã—:'shi', ã™:'su', ã›:'se', ã:'so',
            ãŸ:'ta', ã¡:'chi', ã¤:'tsu', ã¦:'te', ã¨:'to',
            ãª:'na', ã«:'ni', ã¬:'nu', ã­:'ne', ã®:'no',
            ã¯:'ha', ã²:'hi', ãµ:'fu', ã¸:'he', ã»:'ho',
            ã¾:'ma', ã¿:'mi', ã‚€:'mu', ã‚:'me', ã‚‚:'mo',
            ã‚„:'ya', ã‚†:'yu', ã‚ˆ:'yo',
            ã‚‰:'ra', ã‚Š:'ri', ã‚‹:'ru', ã‚Œ:'re', ã‚:'ro',
            ã‚:'wa', ã‚’:'o', ã‚“:'n', // ã‚’ as 'o' is common for particles, 'wo' for others. For simplicity, 'o'.
            ãŒ:'ga', ã:'gi', ã:'gu', ã’:'ge', ã”:'go',
            ã–:'za', ã˜:'ji', ãš:'zu', ãœ:'ze', ã:'zo',
            ã :'da', ã¢:'ji', ã¥:'zu', ã§:'de', ã©:'do', // ã¢/ã¥ often ji/zu
            ã°:'ba', ã³:'bi', ã¶:'bu', ã¹:'be', ã¼:'bo',
            ã±:'pa', ã´:'pi', ã·:'pu', ãº:'pe', ã½:'po'
        };
        const romajiDigraphs = {
            ãã‚ƒ:'kya', ãã‚…:'kyu', ãã‚‡:'kyo',
            ã—ã‚ƒ:'sha', ã—ã‚…:'shu', ã—ã‚‡:'sho',
            ã¡ã‚ƒ:'cha', ã¡ã‚…:'chu', ã¡ã‚‡:'cho',
            ã«ã‚ƒ:'nya', ã«ã‚…:'nyu', ã«ã‚‡:'nyo',
            ã²ã‚ƒ:'hya', ã²ã‚…:'hyu', ã²ã‚‡:'hyo',
            ã¿ã‚ƒ:'mya', ã¿ã‚…:'myu', ã¿ã‚‡:'myo',
            ã‚Šã‚ƒ:'rya', ã‚Šã‚…:'ryu', ã‚Šã‚‡:'ryo',
            ãã‚ƒ:'gya', ãã‚…:'gyu', ãã‚‡:'gyo',
            ã˜ã‚ƒ:'ja', ã˜ã‚…:'ju', ã˜ã‚‡:'jo', // ã˜ + ã‚ƒ/ã‚…/ã‚‡
            ã¢ã‚ƒ:'ja', ã¢ã‚…:'ju', ã¢ã‚‡:'jo', // Alternative for ã˜
            ã³ã‚ƒ:'bya', ã³ã‚…:'byu', ã³ã‚‡:'byo',
            ã´ã‚ƒ:'pya', ã´ã‚…:'pyu', ã´ã‚‡:'pyo'
        };
        // For long vowels, a more robust system would be complex. This is simplified.
        const longVowelMap = { 'ã†': ':', 'ãŠ': ':' , 'ã‚':':', 'ã„':':', 'ãˆ':':'}; // Using colon as a placeholder for macron

        function hiraganaToRomaji(text) {
            if (!text) return "";
            let romaji = "";
            let i = 0;
            while (i < text.length) {
                let consumed = false;
                // Check for 2-character digraphs
                if (i + 1 < text.length) {
                    const twoChar = text.substring(i, i + 2);
                    if (romajiDigraphs[twoChar]) {
                        romaji += romajiDigraphs[twoChar];
                        i += 2;
                        consumed = true;
                    }
                }
                // Check for 1-character monographs if not consumed by digraph
                if (!consumed) {
                    const oneChar = text.charAt(i);
                    if (oneChar === 'ã£') { // Sokuon
                        if (i + 1 < text.length) {
                            const nextChar = text.charAt(i + 1);
                            let nextRomajiInitial = "";
                            if (i + 2 < text.length && romajiDigraphs[text.substring(i+1, i+3)]) {
                                nextRomajiInitial = romajiDigraphs[text.substring(i+1, i+3)].charAt(0);
                            } else if (romajiMonographs[nextChar]) {
                                nextRomajiInitial = romajiMonographs[nextChar].charAt(0);
                            }
                            // Double consonants like t, k, s, p. Avoid doubling n, m, y, w, h or vowels.
                            if (nextRomajiInitial && "tkspc".includes(nextRomajiInitial)) { // c for chi/cha
                                romaji += nextRomajiInitial;
                            } else if (nextRomajiInitial === 'j' && nextChar === 'ã˜') { // Special for ã˜
                                romaji += 'j';
                            }
                            // No else needed, sokuon before vowels or n/m/y/w/h is rare or handled by context later
                        }
                        // Small tsu itself doesn't add to romaji here, it modifies the next.
                        i++; 
                        consumed = true; // Mark as consumed to skip monograph check for 'ã£'
                    } else if (romajiMonographs[oneChar]) {
                        romaji += romajiMonographs[oneChar];
                        // Basic long vowel check: if current char is ãŠ or ãˆ and next is ã† or ã„ respectively
                        if ((oneChar === 'ãŠ' && i + 1 < text.length && text.charAt(i + 1) === 'ã†') ||
                            (oneChar === 'ãˆ' && i + 1 < text.length && text.charAt(i + 1) === 'ã„')) {
                            // This combination (ãŠ+ã† -> Å, ãˆ+ã„ -> Ä“) is common
                            // The current romajiMonographs already maps ãŠ to 'o' and ãˆ to 'e'.
                            // We can add a macron or double the vowel. For simplicity, let's use macron-like representation.
                            // This is a very simplified approach.
                            romaji = romaji.slice(0, -1) + (oneChar === 'ãŠ' ? 'Å' : 'Ä“');
                            i++; // Consume the ã† or ã„
                        }
                        i++;
                        consumed = true;
                    }
                }
                if (!consumed) { // If character is not in maps (e.g., punctuation, Kanji)
                    romaji += text.charAt(i);
                    i++;
                }
            }
            // Further simplify/normalize common long vowel representations
            romaji = romaji.replace(/ou/g, "Å").replace(/oo/g, "Å");
            romaji = romaji.replace(/uu/g, "Å«");
            romaji = romaji.replace(/aa/g, "Ä");
            romaji = romaji.replace(/ei/g, "Ä“").replace(/ee/g, "Ä“");
            romaji = romaji.replace(/ii/g, "Ä«");
            
            // Special 'n' handling before b, m, p
            romaji = romaji.replace(/n([bmp])/g, 'm$1');

            return romaji;
        }


        const htmlElement = document.documentElement;
        const pageTitleElement = document.querySelector('title');
        const uiTitleElement = document.getElementById('uiTitle');
        const answerInputElement = document.getElementById('answerInput');
        const checkButtonElement = document.getElementById('checkButton');
        const nextButtonElement = document.getElementById('nextButton');
        const uiScoreLabelElement = document.getElementById('uiScoreLabel');
        const languageToggleButton = document.getElementById('languageToggle');
        const muteToggleButton = document.getElementById('muteToggle');
        const playSoundButton = document.getElementById('playSoundButton');
        const quizModeSelectElement = document.getElementById('quizModeSelect');
        const uiQuizModeAllOption = document.getElementById('uiQuizModeAll');
        const uiQuizModeNumbersOnlyOption = document.getElementById('uiQuizModeNumbersOnly');
        const uiQuizModeCountersDateTimeOption = document.getElementById('uiQuizModeCountersDateTime');
        const uiQuizModeCountersObjectsOption = document.getElementById('uiQuizModeCountersObjects');
        const uiQuizModeCountersLivingOption = document.getElementById('uiQuizModeCountersLiving');
        const listeningModeToggleButton = document.getElementById('listeningModeToggle');
        const questionArea = document.getElementById('questionArea');

        function updateUIText() {
            const strings = uiStrings[currentLanguage];
            htmlElement.lang = strings.htmlLang;
            pageTitleElement.textContent = strings.pageTitle;
            uiTitleElement.textContent = strings.title;
            answerInputElement.placeholder = isListeningMode ? strings.placeholderListening : strings.placeholderDefault;
            checkButtonElement.textContent = strings.checkAnswer;
            nextButtonElement.textContent = strings.nextQuestion;
            uiScoreLabelElement.textContent = strings.scoreLabel;
            languageToggleButton.textContent = strings.toggleButton;
            muteToggleButton.textContent = isMuted ? strings.unmute : strings.mute;
            muteToggleButton.classList.toggle('muted', isMuted);
            playSoundButton.textContent = strings.playSound;
            
            uiQuizModeAllOption.textContent = strings.quizModeAll;
            uiQuizModeNumbersOnlyOption.textContent = strings.quizModeNumbersOnly;
            uiQuizModeCountersDateTimeOption.textContent = strings.quizModeCountersDateTime;
            uiQuizModeCountersObjectsOption.textContent = strings.quizModeCountersObjects;
            uiQuizModeCountersLivingOption.textContent = strings.quizModeCountersLiving;

            listeningModeToggleButton.textContent = isListeningMode ? strings.listeningModeOn : strings.listeningModeOff;
            listeningModeToggleButton.classList.toggle('active', isListeningMode);

            if (isListeningMode && questionArea.classList.contains('listening-prompt')) {
                 questionArea.textContent = strings.listeningPrompt;
            }
        }

        function initializeQuiz() {
            const browserLang = (navigator.language || navigator.userLanguage || 'zh').toLowerCase();
            currentLanguage = browserLang.startsWith('en') ? 'en' : 'zh';
            currentQuizMode = 'numbers_only';
            quizModeSelectElement.value = currentQuizMode;
            isListeningMode = false;
            updateUIText();
            generateQuestion();
        }

        function speak(textToSpeak, callback) {
            if (!textToSpeak || !synth) { if(callback) callback(); return; }
            if (isMuted) { if(callback) callback(); return; }
            if (synth.speaking) synth.cancel();
            const utterance = new SpeechSynthesisUtterance(textToSpeak);
            utterance.lang = 'ja-JP';
            utterance.rate = 0.9;
            utterance.pitch = 1;
            const voices = synth.getVoices();
            const japaneseVoice = voices.find(voice => voice.lang === 'ja-JP');
            if (japaneseVoice) utterance.voice = japaneseVoice;
            else console.warn("No Japanese voice found, using default.");
            utterance.onend = () => { if(callback) callback(); };
            utterance.onerror = (event) => { console.error('SpeechSynthesisUtterance.onerror', event); if(callback) callback(); };
            synth.speak(utterance);
        }
        if (synth.onvoiceschanged !== undefined) { synth.onvoiceschanged = () => {}; }

        languageToggleButton.addEventListener('click', () => {
            currentLanguage = (currentLanguage === 'zh') ? 'en' : 'zh';
            updateUIText();
            if (feedbackArea.textContent && currentQuestionData) {
                const isCorrect = feedbackArea.classList.contains('correct');
                displayFeedback(isCorrect, currentQuestionData);
            }
        });

        muteToggleButton.addEventListener('click', () => {
            isMuted = !isMuted;
            updateUIText();
            if (isMuted && synth.speaking) synth.cancel();
        });

        playSoundButton.addEventListener('click', () => {
            if (currentQuestionData && currentQuestionData.a) speak(currentQuestionData.a);
        });

        quizModeSelectElement.addEventListener('change', (event) => {
            currentQuizMode = event.target.value;
            generateQuestion();
        });

        listeningModeToggleButton.addEventListener('click', () => {
            isListeningMode = !isListeningMode;
            updateUIText();
            generateQuestion();
        });

        const singleDigitReadings = { '1': 'ã„ã¡', '2': 'ã«', '3': 'ã•ã‚“', '4': 'ã‚ˆã‚“', '5': 'ã”', '6': 'ã‚ã', '7': 'ãªãª', '8': 'ã¯ã¡', '9': 'ãã‚…ã†', '0': '' };
        const singleDigitKanji = { '0': 'é›¶', '1': 'ä¸€', '2': 'äºŒ', '3': 'ä¸‰', '4': 'å››', '5': 'äº”', '6': 'å…­', '7': 'ä¸ƒ', '8': 'å…«', '9': 'ä¹' };

        function numToJapaneseSimple(num_to_convert) {
            if (num_to_convert === 0) return { kanji: "", reading: "" };
            if (num_to_convert > 9999 || num_to_convert < 0) { return {kanji: String(num_to_convert), reading: String(num_to_convert)}; }
            let n = num_to_convert; let k = ""; let r = "";
            if (n >= 1000) {
                const th = Math.floor(n / 1000);
                if (th === 1) { k += "åƒ"; r += "ã›ã‚“"; }
                else { k += (singleDigitKanji[String(th)] || String(th)) + "åƒ";
                    if (th === 3) r += "ã•ã‚“ãœã‚“"; else if (th === 8) r += "ã¯ã£ã›ã‚“";
                    else r += (singleDigitReadings[String(th)] || String(th)) + "ã›ã‚“"; }
                n %= 1000;
            }
            if (n >= 100) {
                const h = Math.floor(n / 100);
                if (h === 1) { k += "ç™¾"; r += "ã²ã‚ƒã"; }
                else { k += (singleDigitKanji[String(h)] || String(h)) + "ç™¾";
                    if (h === 3) r += "ã•ã‚“ã³ã‚ƒã"; else if (h === 6) r += "ã‚ã£ã´ã‚ƒã"; else if (h === 8) r += "ã¯ã£ã´ã‚ƒã";
                    else r += (singleDigitReadings[String(h)] || String(h)) + "ã²ã‚ƒã"; }
                n %= 100;
            }
            if (n >= 10) {
                const t = Math.floor(n / 10);
                if (t === 1) { k += "å"; r += "ã˜ã‚…ã†"; }
                else { k += (singleDigitKanji[String(t)] || String(t)) + "å";
                       r += (singleDigitReadings[String(t)] || String(t)) + "ã˜ã‚…ã†"; }
                n %= 10;
            }
            if (n > 0) { k += singleDigitKanji[String(n)] || String(n); r += singleDigitReadings[String(n)] || String(n); }
            return { kanji: k, reading: r };
        }

        function numToJapanese(num_orig) {
            if (num_orig === 0) return { kanji: "é›¶", reading: "ã‚Œã„" };
            if (num_orig > 99999999 || num_orig < 0) { return {kanji: String(num_orig) + "(è½¬æ¢è¶…å‡ºèŒƒå›´)", reading: String(num_orig) + "(è½¬æ¢è¶…å‡ºèŒƒå›´)"}; }
            let num = num_orig; let k = ""; let r = "";
            if (num >= 10000) {
                const manVal = Math.floor(num / 10000); const manParts = numToJapaneseSimple(manVal);
                k += manParts.kanji + "ä¸‡"; r += manParts.reading + "ã¾ã‚“";
                num %= 10000; if (num === 0) return { kanji: k, reading: r };
            }
            if (num > 0 || k === "") { const restParts = numToJapaneseSimple(num); k += restParts.kanji; r += restParts.reading; }
            if (k === "" && r === "" && num_orig > 0) { return {kanji: String(num_orig), reading: String(num_orig)}; }
            return { kanji: k, reading: r };
        }
        
        function getCounterItem(counterKanji, num) {
            const category = allQuizData.find(cat => cat.counterKanji === counterKanji && cat.type === 'number_counter_list');
            if (category) {
                const item = category.items.find(it => it.num === num);
                if (item) return { q: item.numKanji + (item.qSuffix !== undefined ? item.qSuffix : ''), a: item.a, numKanji: item.numKanji, qSuffix: item.qSuffix };
            }
            const genCategory = allQuizData.find(cat => cat.counterKanji === counterKanji && cat.type === 'number_counter_generated');
            if (genCategory) {
                return genCategory.generator(num); 
            }
            return null;
        }


        const allQuizData = [
            { type: 'standalone_number', categoryTag: 'number', unit: 'ç™¾', values: [ { num: 100, q: 'ç™¾', a: 'ã²ã‚ƒã' }, { num: 200, q: 'äºŒç™¾', a: 'ã«ã²ã‚ƒã' }, { num: 300, q: 'ä¸‰ç™¾', a: 'ã•ã‚“ã³ã‚ƒã' }, { num: 400, q: 'å››ç™¾', a: 'ã‚ˆã‚“ã²ã‚ƒã' }, { num: 500, q: 'äº”ç™¾', a: 'ã”ã²ã‚ƒã' }, { num: 600, q: 'å…­ç™¾', a: 'ã‚ã£ã´ã‚ƒã' }, { num: 700, q: 'ä¸ƒç™¾', a: 'ãªãªã²ã‚ƒã' }, { num: 800, q: 'å…«ç™¾', a: 'ã¯ã£ã´ã‚ƒã' }, { num: 900, q: 'ä¹ç™¾', a: 'ãã‚…ã†ã²ã‚ƒã' } ]},
            { type: 'standalone_number', categoryTag: 'number', unit: 'åƒ', values: [ { num: 1000, q: 'åƒ', a: 'ã›ã‚“' }, { num: 2000, q: 'äºŒåƒ', a: 'ã«ã›ã‚“' }, { num: 3000, q: 'ä¸‰åƒ', a: 'ã•ã‚“ãœã‚“' }, { num: 4000, q: 'å››åƒ', a: 'ã‚ˆã‚“ã›ã‚“' }, { num: 5000, q: 'äº”åƒ', a: 'ã”ã›ã‚“' }, { num: 6000, q: 'å…­åƒ', a: 'ã‚ãã›ã‚“' }, { num: 7000, q: 'ä¸ƒåƒ', a: 'ãªãªã›ã‚“' }, { num: 8000, q: 'å…«åƒ', a: 'ã¯ã£ã›ã‚“' }, { num: 9000, q: 'ä¹åƒ', a: 'ãã‚…ã†ã›ã‚“' } ]},
            { type: 'complex_number', categoryTag: 'number', displayName: 'å¤æ‚æ•°å­—', range: [101, 99999], generator: function() { let num; do { num = getRandomInt(this.range[0], this.range[1]); } while ( (num < 1000 && num % 100 === 0) || (num < 10000 && num % 1000 === 0) ); const jp = numToJapanese(num); return { q: String(num), a: jp.reading, kanji_representation: jp.kanji, original_number: num }; } },
            
            { type: 'number_counter_list', categoryTag: 'datetime', counterKanji: 'æœˆ', items: [ { num: 1, numKanji: 'ä¸€', qSuffix: 'æœˆ', a: 'ã„ã¡ãŒã¤' }, { num: 2, numKanji: 'äºŒ', qSuffix: 'æœˆ', a: 'ã«ãŒã¤' }, { num: 3, numKanji: 'ä¸‰', qSuffix: 'æœˆ', a: 'ã•ã‚“ãŒã¤' }, { num: 4, numKanji: 'å››', qSuffix: 'æœˆ', a: 'ã—ãŒã¤' }, { num: 5, numKanji: 'äº”', qSuffix: 'æœˆ', a: 'ã”ãŒã¤' }, { num: 6, numKanji: 'å…­', qSuffix: 'æœˆ', a: 'ã‚ããŒã¤' }, { num: 7, numKanji: 'ä¸ƒ', qSuffix: 'æœˆ', a: 'ã—ã¡ãŒã¤' }, { num: 8, numKanji: 'å…«', qSuffix: 'æœˆ', a: 'ã¯ã¡ãŒã¤' }, { num: 9, numKanji: 'ä¹', qSuffix: 'æœˆ', a: 'ããŒã¤' }, { num: 10, numKanji: 'å', qSuffix: 'æœˆ', a: 'ã˜ã‚…ã†ãŒã¤' }, { num: 11, numKanji: 'åä¸€', qSuffix: 'æœˆ', a: 'ã˜ã‚…ã†ã„ã¡ãŒã¤' }, { num: 12, numKanji: 'åäºŒ', qSuffix: 'æœˆ', a: 'ã˜ã‚…ã†ã«ãŒã¤' } ]},
            { type: 'number_counter_list', categoryTag: 'datetime', counterKanji: 'æ—¥', items: [ { num: 1, numKanji: 'ä¸€', qSuffix: 'æ—¥', a: 'ã¤ã„ãŸã¡' }, { num: 2, numKanji: 'äºŒ', qSuffix: 'æ—¥', a: 'ãµã¤ã‹' }, { num: 3, numKanji: 'ä¸‰', qSuffix: 'æ—¥', a: 'ã¿ã£ã‹' }, { num: 4, numKanji: 'å››', qSuffix: 'æ—¥', a: 'ã‚ˆã£ã‹' }, { num: 5, numKanji: 'äº”', qSuffix: 'æ—¥', a: 'ã„ã¤ã‹' }, { num: 6, numKanji: 'å…­', qSuffix: 'æ—¥', a: 'ã‚€ã„ã‹' }, { num: 7, numKanji: 'ä¸ƒ', qSuffix: 'æ—¥', a: 'ãªã®ã‹' }, { num: 8, numKanji: 'å…«', qSuffix: 'æ—¥', a: 'ã‚ˆã†ã‹' }, { num: 9, numKanji: 'ä¹', qSuffix: 'æ—¥', a: 'ã“ã“ã®ã‹' }, { num: 10, numKanji: 'å', qSuffix: 'æ—¥', a: 'ã¨ãŠã‹' }, { num: 11, numKanji: 'åä¸€', qSuffix: 'æ—¥', a: 'ã˜ã‚…ã†ã„ã¡ã«ã¡'}, {num: 12, numKanji: 'åäºŒ', qSuffix: 'æ—¥', a: 'ã˜ã‚…ã†ã«ã«ã¡'}, { num: 13, numKanji: 'åä¸‰', qSuffix: 'æ—¥', a: 'ã˜ã‚…ã†ã•ã‚“ã«ã¡'}, { num: 14, numKanji: 'åå››', qSuffix: 'æ—¥', a: 'ã˜ã‚…ã†ã‚ˆã£ã‹' }, {num: 15, numKanji: 'åäº”', qSuffix: 'æ—¥', a: 'ã˜ã‚…ã†ã”ã«ã¡'}, { num: 16, numKanji: 'åå…­', qSuffix: 'æ—¥', a: 'ã˜ã‚…ã†ã‚ãã«ã¡'}, {num: 17, numKanji: 'åä¸ƒ', qSuffix: 'æ—¥', a: 'ã˜ã‚…ã†ã—ã¡ã«ã¡'}, {num: 18, numKanji: 'åå…«', qSuffix: 'æ—¥', a: 'ã˜ã‚…ã†ã¯ã¡ã«ã¡'}, {num: 19, numKanji: 'åä¹', qSuffix: 'æ—¥', a: 'ã˜ã‚…ã†ãã«ã¡'}, { num: 20, numKanji: 'äºŒå', qSuffix: 'æ—¥', a: 'ã¯ã¤ã‹' }, { num: 21, numKanji: 'äºŒåä¸€', qSuffix: 'æ—¥', a: 'ã«ã˜ã‚…ã†ã„ã¡ã«ã¡'}, { num: 24, numKanji: 'äºŒåå››', qSuffix: 'æ—¥', a: 'ã«ã˜ã‚…ã†ã‚ˆã£ã‹' } ]},
            { type: 'number_counter_list', categoryTag: 'object', counterKanji: 'ã¤', items: [ { num: 1, numKanji: 'ä¸€', qSuffix: 'ã¤', a: 'ã²ã¨ã¤' }, { num: 2, numKanji: 'äºŒ', qSuffix: 'ã¤', a: 'ãµãŸã¤' }, { num: 3, numKanji: 'ä¸‰', qSuffix: 'ã¤', a: 'ã¿ã£ã¤' }, { num: 4, numKanji: 'å››', qSuffix: 'ã¤', a: 'ã‚ˆã£ã¤' }, { num: 5, numKanji: 'äº”', qSuffix: 'ã¤', a: 'ã„ã¤ã¤' }, { num: 6, numKanji: 'å…­', qSuffix: 'ã¤', a: 'ã‚€ã£ã¤' }, { num: 7, numKanji: 'ä¸ƒ', qSuffix: 'ã¤', a: 'ãªãªã¤' }, { num: 8, numKanji: 'å…«', qSuffix: 'ã¤', a: 'ã‚„ã£ã¤' }, { num: 9, numKanji: 'ä¹', qSuffix: 'ã¤', a: 'ã“ã“ã®ã¤' }, { num: 10, numKanji: 'å', qSuffix: '', a: 'ã¨ãŠ' } ]},

            { type: 'number_counter_generated', categoryTag: 'datetime', counterKanji: 'æ™‚', range: [1, 12], generator: (num) => { const { kanji: k, reading: r } = numToJapaneseSimple(num); let a = ''; if (num === 4) a = 'ã‚ˆã˜'; else if (num === 7) a = 'ã—ã¡ã˜'; else if (num === 9) a = 'ãã˜'; else a = r + 'ã˜'; return { q: k + 'æ™‚', a: a, original_number: num }; }},
            { type: 'number_counter_generated', categoryTag: 'datetime', counterKanji: 'åˆ†', range: [1, 59], generator: (num) => { const { kanji: k, reading: r } = numToJapaneseSimple(num); let a = ''; const ld = num % 10; if (num === 1) a = 'ã„ã£ã·ã‚“'; else if (num === 3 || (num > 10 && ld === 3)) a = r.slice(0, r.length - singleDigitReadings['3'].length) + 'ã•ã‚“ã·ã‚“'; else if (num === 4 || (num > 10 && ld === 4)) a = r.slice(0, r.length - singleDigitReadings['4'].length) + 'ã‚ˆã‚“ã·ã‚“'; else if (num === 6 || (num > 10 && ld === 6)) a = r.slice(0, r.length - singleDigitReadings['6'].length) + 'ã‚ã£ã·ã‚“'; else if (num === 8 || (num > 10 && ld === 8)) a = r.slice(0, r.length - singleDigitReadings['8'].length) + 'ã¯ã£ã·ã‚“'; else if (num % 10 === 0) { if (num === 10) a = 'ã˜ã‚…ã£ã·ã‚“'; else a = r.slice(0, -3) + 'ã£ã·ã‚“'; } else if (num > 10 && ld === 1) a = r.slice(0, r.length - singleDigitReadings['1'].length) + 'ã„ã£ã·ã‚“'; else a = r + 'ãµã‚“'; if (num === 10) a = 'ã˜ã‚…ã£ã·ã‚“'; if (num === 20) a = 'ã«ã˜ã£ã·ã‚“'; if (num === 30) a = 'ã•ã‚“ã˜ã£ã·ã‚“'; if (num === 40) a = 'ã‚ˆã‚“ã˜ã£ã·ã‚“'; if (num === 50) a = 'ã”ã˜ã£ã·ã‚“'; return { q: k + 'åˆ†', a: a, original_number: num }; }},
            
            { type: 'number_counter_generated', categoryTag: 'object', counterKanji: 'å›', range: [1, 10], generator: (num) => { const { kanji: k, reading: r } = numToJapaneseSimple(num); let a = ''; if (num === 1) a = 'ã„ã£ã‹ã„'; else if (num === 6) a = 'ã‚ã£ã‹ã„'; else if (num === 8) a = 'ã¯ã£ã‹ã„'; else if (num === 10) a = 'ã˜ã£ã‹ã„'; else a = r + 'ã‹ã„'; return { q: k + 'å›', a: a, original_number: num }; }},
            { type: 'number_counter_generated', categoryTag: 'object', counterKanji: 'å†Š', range: [1, 10], generator: (num) => { const { kanji: k, reading: r } = numToJapaneseSimple(num); let a = ''; if (num === 1) a = 'ã„ã£ã•ã¤'; else if (num === 8) a = 'ã¯ã£ã•ã¤'; else if (num === 10) a = 'ã˜ã£ã•ã¤'; else a = r + 'ã•ã¤'; return { q: k + 'å†Š', a: a, original_number: num }; }},
            { type: 'number_counter_generated', categoryTag: 'object', counterKanji: 'ç€', range: [1, 10], generator: (num) => { const { kanji: k, reading: r } = numToJapaneseSimple(num); let a = ''; if (num === 1) a = 'ã„ã£ã¡ã‚ƒã'; else if (num === 8) a = 'ã¯ã£ã¡ã‚ƒã'; else if (num === 10) a = 'ã˜ã£ã¡ã‚ƒã'; else a = r + 'ã¡ã‚ƒã'; return { q: k + 'ç€', a: a, original_number: num }; }},
            { type: 'number_counter_generated', categoryTag: 'object', counterKanji: 'æš', range: [1, 10], generator: (num) => { const { kanji: k, reading: r } = numToJapaneseSimple(num); return { q: k + 'æš', a: r + 'ã¾ã„', original_number: num }; }},
            { type: 'number_counter_generated', categoryTag: 'object', counterKanji: 'éš', range: [1, 10], generator: (num) => { const { kanji: k, reading: r } = numToJapaneseSimple(num); let a = ''; if (num === 1) a = 'ã„ã£ã‹ã„'; else if (num === 3) a = 'ã•ã‚“ãŒã„'; else if (num === 6) a = 'ã‚ã£ã‹ã„'; else if (num === 8) a = 'ã¯ã£ã‹ã„'; else if (num === 10) a = 'ã˜ã‚…ã£ã‹ã„'; else a = r + 'ã‹ã„'; return { q: k + 'éš', a: a, original_number: num }; }},
            { type: 'number_counter_generated', categoryTag: 'object', counterKanji: 'æ¯', range: [1, 10], generator: (num) => { const { kanji: k, reading: r } = numToJapaneseSimple(num); let a = ''; if (num === 1) a = 'ã„ã£ã±ã„'; else if (num === 3) a = 'ã•ã‚“ã°ã„'; else if (num === 6) a = 'ã‚ã£ã±ã„'; else if (num === 8) a = 'ã¯ã£ã±ã„'; else if (num === 10) a = 'ã˜ã‚…ã£ã±ã„'; else a = r + 'ã¯ã„'; return { q: k + 'æ¯', a: a, original_number: num }; }},
            { type: 'number_counter_generated', categoryTag: 'object', counterKanji: 'æœ¬', range: [1, 10], generator: (num) => { const { kanji: k, reading: r } = numToJapaneseSimple(num); let a = ''; if (num === 1) a = 'ã„ã£ã½ã‚“'; else if (num === 3) a = 'ã•ã‚“ã¼ã‚“'; else if (num === 6) a = 'ã‚ã£ã½ã‚“'; else if (num === 8) a = 'ã¯ã£ã½ã‚“'; else if (num === 10) a = 'ã˜ã‚…ã£ã½ã‚“'; else a = r + 'ã»ã‚“'; return { q: k + 'æœ¬', a: a, original_number: num }; }},

            { type: 'number_counter_generated', categoryTag: 'living', counterKanji: 'äºº', range: [1, 10], generator: (num) => { const { kanji: k, reading: r } = numToJapaneseSimple(num); let a = ''; if (num === 1) a = 'ã²ã¨ã‚Š'; else if (num === 2) a = 'ãµãŸã‚Š'; else if (num === 4) a = 'ã‚ˆã«ã‚“'; else a = r + 'ã«ã‚“'; return { q: k + 'äºº', a: a, original_number: num }; }},
            { type: 'number_counter_generated', categoryTag: 'living', counterKanji: 'åŒ¹', range: [1, 10], generator: (num) => { const { kanji: k, reading: r } = numToJapaneseSimple(num); let a = ''; if (num === 1) a = 'ã„ã£ã´ã'; else if (num === 3) a = 'ã•ã‚“ã³ã'; else if (num === 6) a = 'ã‚ã£ã´ã'; else if (num === 8) a = 'ã¯ã£ã´ã'; else if (num === 10) a = 'ã˜ã‚…ã£ã´ã'; else a = r + 'ã²ã'; return { q: k + 'åŒ¹', a: a, original_number: num }; }},
            { type: 'number_counter_generated', categoryTag: 'living', counterKanji: 'ç¾½', range: [1, 10], generator: (num) => { const { kanji: k, reading: r } = numToJapaneseSimple(num); let a = ''; if (num === 3) a = 'ã•ã‚“ã°'; else if (num === 6) a = 'ã‚ã£ã±'; else if (num === 8) a = 'ã¯ã£ã±'; else if (num === 10) a = 'ã˜ã‚…ã£ã±'; else a = r + 'ã‚'; return { q: k + 'ç¾½', a: a, original_number: num }; }},
            
            { type: 'complex_datetime_combination', categoryTag: 'datetime', generator: function() {
                let qKanji = ''; let aHiragana = ''; const components = []; 
                const numComponents = getRandomInt(2, 3); 
                const availableParts = ['month', 'day', 'hour', 'minute'];
                const chosenParts = [];
                for (let i = availableParts.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [availableParts[i], availableParts[j]] = [availableParts[j], availableParts[i]];
                }
                for(let i=0; i < numComponents; i++) { chosenParts.push(availableParts[i]); }
                chosenParts.sort((p1, p2) => ['month', 'day', 'hour', 'minute'].indexOf(p1) - ['month', 'day', 'hour', 'minute'].indexOf(p2));

                if (chosenParts.includes('month')) {
                    const monthData = getCounterItem('æœˆ', getRandomInt(1, 12));
                    if (monthData) components.push({ q: monthData.q, a: monthData.a });
                }
                if (chosenParts.includes('day')) {
                    const dayList = allQuizData.find(d => d.counterKanji === 'æ—¥').items;
                    const randomDayItem = dayList[getRandomInt(0, dayList.length - 1)];
                    components.push({ q: randomDayItem.numKanji + randomDayItem.qSuffix, a: randomDayItem.a });
                }
                if (chosenParts.includes('hour')) {
                    const hourData = getCounterItem('æ™‚', getRandomInt(1, 12));
                    if (hourData) components.push({ q: hourData.q, a: hourData.a });
                }
                if (chosenParts.includes('minute') && components.length < 3) { 
                    let minuteNum = (getRandomInt(1,2) === 1) ? getRandomInt(0,11) * 5 : getRandomInt(1, 59);
                    if (minuteNum === 0 && components.length > 0) {} 
                    else if (minuteNum > 0) {
                        const minuteData = getCounterItem('åˆ†', minuteNum);
                        if (minuteData) components.push({ q: minuteData.q, a: minuteData.a });
                    }
                }
                if (components.length < 2) { /* Add fallback component if needed */ }
                qKanji = components.map(c => c.q).join(''); aHiragana = components.map(c => c.a).join('');
                if (!qKanji) { /* Fallback if qKanji is still empty */
                    const hourData = getCounterItem('æ™‚', getRandomInt(1,12)); const minuteData = getCounterItem('åˆ†', getRandomInt(1,59));
                    qKanji = hourData.q + minuteData.q; aHiragana = hourData.a + minuteData.a;
                }
                return { q: qKanji, a: aHiragana, original_number: null, type: 'complex_datetime_combination' }; 
            }}
        ];

        const feedbackArea = document.getElementById('feedbackArea');
        const scoreDisplay = document.getElementById('score');
        let currentQuestionData = null;
        let score = 0;

        function getRandomInt(min, max) {
            min = Math.ceil(min); max = Math.floor(max);
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function generateQuestion() {
            answerInputElement.value = ''; feedbackArea.textContent = ''; feedbackArea.className = '';
            answerInputElement.disabled = true;
            checkButtonElement.disabled = true;
            playSoundButton.disabled = true;

            let eligibleCategories = allQuizData;
            if (currentQuizMode === 'numbers_only') {
                eligibleCategories = allQuizData.filter(item => item.categoryTag === 'number');
            } else if (currentQuizMode === 'counters_datetime') {
                eligibleCategories = allQuizData.filter(item => item.categoryTag === 'datetime');
            } else if (currentQuizMode === 'counters_objects') {
                eligibleCategories = allQuizData.filter(item => item.categoryTag === 'object');
            } else if (currentQuizMode === 'counters_living') {
                eligibleCategories = allQuizData.filter(item => item.categoryTag === 'living');
            }

            if (eligibleCategories.length === 0) {
                console.warn("No data for mode:", currentQuizMode, "Fallback to all.");
                eligibleCategories = allQuizData; 
                if (allQuizData.length > 0 && currentQuizMode !== 'all') { 
                    currentQuizMode = 'all'; quizModeSelectElement.value = 'all';
                } else if (allQuizData.length === 0) {
                    questionArea.textContent = uiStrings[currentLanguage].listeningPrompt.includes("æ²¡æœ‰") ? "æ²¡æœ‰å¯ç”¨çš„é—®é¢˜ã€‚" : "No questions available.";
                    return;
                }
            }
            updateUIText();

            const catIdx = getRandomInt(0, eligibleCategories.length - 1);
            const category = eligibleCategories[catIdx];
            
            if (category.type === 'standalone_number' || category.type === 'number_counter_list') {
                const items = category.values || category.items;
                const itemIdx = getRandomInt(0, items.length - 1);
                currentQuestionData = { ...items[itemIdx], type: category.type, categoryTag: category.categoryTag };
                if (category.type === 'number_counter_list') {
                    currentQuestionData.q = items[itemIdx].numKanji + (items[itemIdx].qSuffix !== undefined ? items[itemIdx].qSuffix : category.counterKanji);
                     if (category.counterKanji === 'ã¤' && items[itemIdx].num === 10) currentQuestionData.q = items[itemIdx].numKanji;
                     else if (category.counterKanji === 'ã¤') currentQuestionData.q = items[itemIdx].numKanji + "ã¤";
                }
                currentQuestionData.original_number = items[itemIdx].num; 
            } else if (category.type === 'number_counter_generated' || category.type === 'complex_number' || category.type === 'complex_datetime_combination') {
                const numGen = (category.type === 'complex_number' || category.type === 'complex_datetime_combination') ? null : getRandomInt(category.range[0], category.range[1]);
                currentQuestionData = category.generator(numGen); 
                if (!currentQuestionData.categoryTag) currentQuestionData.categoryTag = category.categoryTag; 
            }

            if (isListeningMode) {
                questionArea.textContent = uiStrings[currentLanguage].listeningPrompt;
                questionArea.classList.add('listening-prompt');
                speak(currentQuestionData.a, () => {
                    answerInputElement.disabled = false;
                    checkButtonElement.disabled = false;
                    playSoundButton.disabled = false;
                    if (!isMuted) answerInputElement.focus();
                });
            } else {
                questionArea.textContent = currentQuestionData.q;
                questionArea.classList.remove('listening-prompt');
                answerInputElement.disabled = false;
                checkButtonElement.disabled = false;
                playSoundButton.disabled = true;
            }
        }
        
        function displayFeedback(isCorrectFlag, data) {
            const strings = uiStrings[currentLanguage];
            if (isCorrectFlag) {
                feedbackArea.textContent = strings.correctFeedback; // Emoji ğŸ‰ is part of this string
                if (data.type === 'complex_number') feedbackArea.textContent += ` (${data.kanji_representation} / ${data.a})`;
                else if (data.type === 'standalone_number') feedbackArea.textContent += ` (${data.q} / ${data.a})`;
                else if (data.type === 'number_counter_list' || data.type === 'number_counter_generated' || data.type === 'complex_datetime_combination') feedbackArea.textContent += ` (${data.q} / ${data.a})`;
                feedbackArea.className = 'correct';
            } else {
                let correctAnswerDisplay = data.a;
                if (isListeningMode) {
                    if (data.type === 'standalone_number' || data.type === 'complex_number') {
                        const writtenForm = data.type === 'standalone_number' ? data.q : data.kanji_representation;
                        correctAnswerDisplay = `${writtenForm} (${data.a})`;
                    } else { 
                        correctAnswerDisplay = `${data.q} (${data.a})`;
                    }
                } else { 
                     correctAnswerDisplay = data.a;
                     if (data.kanji_representation && data.kanji_representation !== data.q && data.type === 'complex_number') correctAnswerDisplay += ` (${data.kanji_representation})`;
                     else if (data.type !== 'complex_number' && data.type !== 'complex_datetime_combination' && data.q !== data.a) correctAnswerDisplay += ` (${data.q})`;
                     else if (data.type === 'complex_datetime_combination') correctAnswerDisplay += ` (${data.q})`
                }
                feedbackArea.textContent = `${strings.incorrectFeedbackPrefix}${correctAnswerDisplay}`;
                feedbackArea.className = 'incorrect';
            }
        }

        function checkAnswer() {
            const userAnswerRaw = answerInputElement.value.trim();
            const userAnswer = userAnswerRaw.toLowerCase().replace(/ã‚”/g, 'ã†ã‚›'); 
            const hiraganaAnswer = currentQuestionData.a;
            // Normalize Romaji: remove macrons for comparison, handle common variations
            const normalizeRomaji = (r) => r.replace(/[ÅÅ«ÄÄ“Ä«]/g, (match) => ({'Å':'ou', 'Å«':'uu', 'Ä':'aa', 'Ä“':'ei', 'Ä«':'ii'}[match] || match))
                                          .replace(/n([bmp])/g, 'm$1'); // n before b/m/p -> m
            
            const romajiAnswerTarget = normalizeRomaji(hiraganaToRomaji(hiraganaAnswer).toLowerCase());
            const userAnswerNormalizedRomaji = normalizeRomaji(userAnswer);


            let isCorrect = false;
            if (isListeningMode) {
                if (currentQuestionData.type === 'standalone_number' || currentQuestionData.type === 'complex_number') {
                    const arabicAnswer = String(currentQuestionData.original_number);
                    const kanjiAnswer = (currentQuestionData.type === 'standalone_number' ? currentQuestionData.q : currentQuestionData.kanji_representation).toLowerCase();
                    isCorrect = userAnswer === arabicAnswer || userAnswer === kanjiAnswer || userAnswerNormalizedRomaji === romajiAnswerTarget;
                } else { // Counters and Complex Datetime
                    isCorrect = userAnswer === currentQuestionData.q.toLowerCase() || userAnswerNormalizedRomaji === romajiAnswerTarget;
                }
            } else { // Visual mode (expecting Hiragana or Romaji that converts to the Hiragana)
                isCorrect = userAnswer === hiraganaAnswer || userAnswerNormalizedRomaji === romajiAnswerTarget;
            }

            if (isCorrect) {
                score++; scoreDisplay.textContent = score;
            }
            displayFeedback(isCorrect, currentQuestionData); 

            answerInputElement.disabled = true; checkButtonElement.disabled = true;
            playSoundButton.disabled = false;
        }

        checkButtonElement.addEventListener('click', checkAnswer);
        nextButtonElement.addEventListener('click', generateQuestion);
        answerInputElement.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                if (!checkButtonElement.disabled) { checkAnswer(); }
                else { generateQuestion(); }
            }
        });

        initializeQuiz();
    </script>
</body>
</html>
