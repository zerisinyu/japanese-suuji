<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Japanese Numbers & Counters Quiz</title>
    <style>
        :root {
            --primary-color: #4A90E2; /* A modern blue */
            --secondary-color: #50E3C2; /* A vibrant teal/mint */
            --background-color: #f7f9fc; /* Light, clean background */
            --card-background-color: #ffffff;
            --text-color: #333333;
            --text-light-color: #555555;
            --border-color: #e0e0e0;
            --success-color: #4CAF50; /* Green for correct answers */
            --error-color: #F44336;   /* Red for incorrect answers */
            --button-text-color: #ffffff;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';
        }

        body {
            font-family: var(--font-family);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: var(--background-color);
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            color: var(--text-color);
        }

        .top-controls {
            display: flex;
            flex-wrap: wrap; /* This allows items to wrap to the next line */
            justify-content: center; /* Centers items on the line, and centers wrapped lines */
            gap: 12px;
            margin-bottom: 25px;
            align-items: center;
        }

        .control-button, .mode-selector select {
            background-color: var(--card-background-color);
            color: var(--primary-color);
            border: 1px solid var(--border-color);
            padding: 10px 18px;
            border-radius: 20px; /* More rounded buttons */
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: background-color 0.2s ease, color 0.2s ease, box-shadow 0.2s ease, transform 0.1s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            height: 40px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        .mode-selector select {
             background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%234A90E2%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.4-12.8z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 10px;
            padding-right: 35px;
        }

        .control-button:hover, .mode-selector select:hover {
            background-color: var(--primary-color);
            color: var(--button-text-color);
            border-color: var(--primary-color);
            box-shadow: 0 4px 10px rgba(74, 144, 226, 0.2);
        }
         .control-button:hover.mode-selector select, .mode-selector select:hover { 
            /* Ensure arrow color changes on select hover too */
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23FFFFFF%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.4-12.8z%22%2F%3E%3C%2Fsvg%3E');
        }
        .control-button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        #muteToggle.muted {
            background-color: var(--secondary-color);
            color: var(--button-text-color);
            border-color: var(--secondary-color);
        }
         #listeningModeToggle.active {
            background-color: var(--secondary-color);
            color: var(--button-text-color);
            border-color: var(--secondary-color);
        }


        .mode-selector {
            display: flex;
            align-items: center;
        }

        #playSoundButton {
            background-color: var(--secondary-color);
            color: var(--button-text-color);
            border: none;
            margin-top: 15px;
            padding: 12px 20px;
            font-size: 1em;
            font-weight: 500;
            border-radius: 20px;
        }
        #playSoundButton:disabled {
            background-color: #e0e0e0;
            color: #9e9e9e;
            cursor: not-allowed;
            box-shadow: none;
        }
         #playSoundButton:hover:not(:disabled) {
            background-color: #45D1B5; /* Darker shade of secondary */
            box-shadow: 0 4px 10px rgba(80, 227, 194, 0.2);
        }


        .quiz-container {
            background-color: var(--card-background-color);
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 600px;
            text-align: center;
        }

        h1 {
            color: var(--text-color);
            margin-bottom: 35px;
            font-size: 2.2em;
            font-weight: 600;
        }

        #questionArea {
            font-size: 3em;
            color: var(--primary-color);
            margin-bottom: 35px;
            padding: 25px;
            background-color: #edf6ff; /* Lighter shade of primary for question bg */
            border-radius: 12px;
            min-height: 80px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 700;
            line-height: 1.3;
        }
        #questionArea.listening-prompt {
            font-size: 1.6em;
            color: var(--secondary-color);
            background-color: #e6fffa; /* Lighter shade of secondary */
        }


        #answerInput {
            width: calc(100% - 30px);
            padding: 16px;
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 1.25em;
            box-sizing: border-box;
            color: var(--text-color);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        #answerInput:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
        }
        #answerInput::placeholder { color: #a0aec0; }

        .buttons-group { display: flex; justify-content: center; gap: 20px; }

        button.quiz-button {
            color: var(--button-text-color);
            border: none;
            padding: 15px 25px;
            border-radius: 25px; /* Pill shape */
            cursor: pointer;
            font-size: 1.15em;
            font-weight: 600;
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            min-width: 140px; /* Ensure buttons have a good width */
        }
        button.quiz-button:hover {
             box-shadow: 0 6px 12px rgba(0,0,0,0.15);
             transform: translateY(-2px);
        }
        button.quiz-button:active {
            transform: translateY(0px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        #checkButton { background-color: var(--success-color); }
        #checkButton:hover { background-color: #45a049; }
        #nextButton { background-color: var(--primary-color); }
        #nextButton:hover { background-color: #3A7BC8; }

        #feedbackArea { margin-top: 30px; font-size: 1.2em; min-height: 40px; font-weight: 600; }
        .correct { color: var(--success-color); }
        .incorrect { color: var(--error-color); }
        #scoreArea { margin-top: 35px; font-size: 1.3em; color: var(--text-light-color); font-weight: 500; }

        @media (max-width: 600px) {
            .top-controls {
                /* Removed flex-direction: column; to allow wrapping */
                /* justify-content: center; and flex-wrap: wrap; are inherited */
                gap: 10px; /* Adjusted gap for potentially tighter space */
            }
            .control-button, .mode-selector select { /* Ensure items can shrink if needed */
                flex-shrink: 1;
            }
            .mode-selector {
                /* width: 100%; /* This might make it take full width if it's the only item on a line */
                /* justify-content: center; /* Center select if mode-selector takes full width */
                /* Consider if mode-selector should have a max-width or if select's max-width is enough */
            }
            .mode-selector select {
                width: auto; /* Allow select to size based on content */
                /* flex-grow: 1; /* Removed to prevent it from taking too much space on a wrapped line */
                max-width: 220px; /* Prevent it from becoming too wide */
            }
            .quiz-container { padding: 30px 20px; }
            h1 { font-size: 1.8em; }
            #questionArea { font-size: 2.5em; padding: 20px; min-height: 70px; }
            #questionArea.listening-prompt { font-size: 1.4em; }
            #answerInput, button.quiz-button { font-size: 1.05em; padding: 14px 20px; }
            .control-button, #playSoundButton, .mode-selector select { font-size: 0.9em; padding: 10px 15px; height: 38px;}
            .mode-selector select { padding-right: 30px; }
            button.quiz-button { min-width: 120px; }
        }
    </style>
</head>
<body>
    <div class="top-controls">
        <button id="languageToggle" class="control-button">ÂàáÊç¢ËØ≠Ë®Ä</button>
        <button id="muteToggle" class="control-button">ÈùôÈü≥</button>
        <div class="mode-selector">
            <select id="quizModeSelect" class="control-button">
                <option value="all" id="uiQuizModeAll">ÂÖ®ÈÉ®</option>
                <option value="numbers" id="uiQuizModeNumbers" selected>‰ªÖÊï∞Â≠ó</option>
                <option value="counters" id="uiQuizModeCounters">‰ªÖÈáèËØç</option>
            </select>
        </div>
        <button id="listeningModeToggle" class="control-button">Âê¨ÂÜôÊ®°Âºè</button>
    </div>

    <div class="quiz-container">
        <h1 id="uiTitle">Êó•ËØ≠Êï∞Â≠óÂíåÈáèËØçÁªÉ‰π†</h1>
        <div id="questionArea"></div>
        <input type="text" id="answerInput" placeholder="ËØ∑ËæìÂÖ•ËØªÈü≥ (Âπ≥ÂÅáÂêç)">
        <div class="buttons-group">
            <button id="checkButton" class="quiz-button">Ê£ÄÊü•Á≠îÊ°à</button>
            <button id="nextButton" class="quiz-button">‰∏ã‰∏Ä‰∏™</button>
        </div>
        <div id="feedbackArea"></div>
        <button id="playSoundButton" class="control-button" disabled>Êí≠ÊîæÂ£∞Èü≥</button>
        <div id="scoreArea"><span id="uiScoreLabel">ÂàÜÊï∞</span>: <span id="score">0</span></div>
    </div>

    <script>
        const uiStrings = {
            zh: {
                htmlLang: 'zh-CN', title: 'Êó•ËØ≠Êï∞Â≠óÂíåÈáèËØçÁªÉ‰π†', checkAnswer: 'Ê£ÄÊü•Á≠îÊ°à', nextQuestion: '‰∏ã‰∏Ä‰∏™',
                scoreLabel: 'ÂàÜÊï∞', placeholderDefault: 'ËØ∑ËæìÂÖ•ËØªÈü≥ (Âπ≥ÂÅáÂêç)', placeholderListening: 'ËØ∑ÂÜôÂÖ•Âê¨Âà∞ÁöÑÂÜÖÂÆπ',
                correctFeedback: 'Ê≠£Á°ÆÔºÅ üéâ', incorrectFeedbackPrefix: 'ÈîôËØØ„ÄÇÊ≠£Á°ÆÁ≠îÊ°àÊòØ: ', inputPrompt: 'ËØ∑ËæìÂÖ•Á≠îÊ°àÔºÅ',
                toggleButton: 'ÂàáÊç¢Ëá≥ English', pageTitle: 'Êó•ËØ≠Êï∞Â≠óÂíåÈáèËØçÁªÉ‰π†', mute: 'ÈùôÈü≥', unmute: 'ÂèñÊ∂àÈùôÈü≥',
                playSound: 'Êí≠ÊîæÂ£∞Èü≥', quizModeAll: 'ÂÖ®ÈÉ®', quizModeNumbers: '‰ªÖÊï∞Â≠ó',
                quizModeCounters: '‰ªÖÈáèËØç', listeningModeOn: 'ËßÜËßâÊ®°Âºè', listeningModeOff: 'Âê¨ÂÜôÊ®°Âºè',
                listeningPrompt: 'ËØ∑Âê¨Â£∞Èü≥...'
            },
            en: {
                htmlLang: 'en', title: 'Japanese Numbers & Counters Quiz', checkAnswer: 'Check Answer', nextQuestion: 'Next',
                scoreLabel: 'Score', placeholderDefault: 'Enter reading (Hiragana)', placeholderListening: 'Write what you hear',
                correctFeedback: 'Correct! üéâ', incorrectFeedbackPrefix: 'Incorrect. The correct answer is: ', inputPrompt: 'Please enter an answer!',
                toggleButton: 'ÂàáÊç¢Ëá≥ ‰∏≠Êñá', pageTitle: 'Japanese Quiz', mute: 'Mute', unmute: 'Unmute',
                playSound: 'Play Sound', quizModeAll: 'All', quizModeNumbers: 'Numbers Only',
                quizModeCounters: 'Counters Only', listeningModeOn: 'Visual Mode', listeningModeOff: 'Listening Mode',
                listeningPrompt: 'Listen to the audio...'
            }
        };
        let currentLanguage = 'zh';
        let isMuted = false;
        const synth = window.speechSynthesis;
        let currentQuizMode = 'numbers';
        let isListeningMode = false;

        const htmlElement = document.documentElement;
        const pageTitleElement = document.querySelector('title');
        const uiTitleElement = document.getElementById('uiTitle');
        const answerInputElement = document.getElementById('answerInput');
        const checkButtonElement = document.getElementById('checkButton');
        const nextButtonElement = document.getElementById('nextButton');
        const uiScoreLabelElement = document.getElementById('uiScoreLabel');
        const languageToggleButton = document.getElementById('languageToggle');
        const muteToggleButton = document.getElementById('muteToggle');
        const playSoundButton = document.getElementById('playSoundButton');
        const quizModeSelectElement = document.getElementById('quizModeSelect');
        const uiQuizModeAllOption = document.getElementById('uiQuizModeAll');
        const uiQuizModeNumbersOption = document.getElementById('uiQuizModeNumbers');
        const uiQuizModeCountersOption = document.getElementById('uiQuizModeCounters');
        const listeningModeToggleButton = document.getElementById('listeningModeToggle');
        const questionArea = document.getElementById('questionArea');

        function updateUIText() {
            const strings = uiStrings[currentLanguage];
            htmlElement.lang = strings.htmlLang;
            pageTitleElement.textContent = strings.pageTitle;
            uiTitleElement.textContent = strings.title;
            answerInputElement.placeholder = isListeningMode ? strings.placeholderListening : strings.placeholderDefault;
            checkButtonElement.textContent = strings.checkAnswer;
            nextButtonElement.textContent = strings.nextQuestion;
            uiScoreLabelElement.textContent = strings.scoreLabel;
            languageToggleButton.textContent = strings.toggleButton;
            muteToggleButton.textContent = isMuted ? strings.unmute : strings.mute;
            muteToggleButton.classList.toggle('muted', isMuted);
            playSoundButton.textContent = strings.playSound;
            uiQuizModeAllOption.textContent = strings.quizModeAll;
            uiQuizModeNumbersOption.textContent = strings.quizModeNumbers;
            uiQuizModeCountersOption.textContent = strings.quizModeCounters;
            listeningModeToggleButton.textContent = isListeningMode ? strings.listeningModeOn : strings.listeningModeOff;
            listeningModeToggleButton.classList.toggle('active', isListeningMode);


            if (isListeningMode && questionArea.classList.contains('listening-prompt')) {
                 questionArea.textContent = strings.listeningPrompt;
            }
        }

        function initializeQuiz() {
            const browserLang = (navigator.language || navigator.userLanguage || 'zh').toLowerCase();
            currentLanguage = browserLang.startsWith('en') ? 'en' : 'zh';
            currentQuizMode = 'numbers';
            quizModeSelectElement.value = currentQuizMode;
            isListeningMode = false;
            updateUIText();
            generateQuestion();
        }

        function speak(textToSpeak, callback) {
            if (!textToSpeak || !synth) { if(callback) callback(); return; }
            if (isMuted) { if(callback) callback(); return; }
            if (synth.speaking) synth.cancel();
            const utterance = new SpeechSynthesisUtterance(textToSpeak);
            utterance.lang = 'ja-JP';
            utterance.rate = 0.9;
            utterance.pitch = 1;
            const voices = synth.getVoices();
            const japaneseVoice = voices.find(voice => voice.lang === 'ja-JP');
            if (japaneseVoice) utterance.voice = japaneseVoice;
            else console.warn("No Japanese voice found, using default.");
            utterance.onend = () => { if(callback) callback(); };
            utterance.onerror = (event) => { console.error('SpeechSynthesisUtterance.onerror', event); if(callback) callback(); };
            synth.speak(utterance);
        }
        if (synth.onvoiceschanged !== undefined) { synth.onvoiceschanged = () => {}; }

        languageToggleButton.addEventListener('click', () => {
            currentLanguage = (currentLanguage === 'zh') ? 'en' : 'zh';
            updateUIText();
            if (feedbackArea.textContent && currentQuestionData) {
                const isCorrect = feedbackArea.classList.contains('correct');
                const answer = currentQuestionData.a;
                const strings = uiStrings[currentLanguage];
                if (isCorrect) {
                     feedbackArea.textContent = strings.correctFeedback;
                     if (currentQuestionData.type === 'complex_number' && currentQuestionData.kanji_representation) {
                        feedbackArea.textContent += ` (${currentQuestionData.kanji_representation})`;
                     }
                } else {
                    let text = `${strings.incorrectFeedbackPrefix}${answer}`;
                    if (currentQuestionData.type === 'complex_number' && currentQuestionData.kanji_representation) {
                        text += ` ( ${currentQuestionData.kanji_representation} )`;
                    }
                    feedbackArea.textContent = text;
                }
            }
        });

        muteToggleButton.addEventListener('click', () => {
            isMuted = !isMuted;
            updateUIText();
            if (isMuted && synth.speaking) synth.cancel();
        });

        playSoundButton.addEventListener('click', () => {
            if (currentQuestionData && currentQuestionData.a) speak(currentQuestionData.a);
        });

        quizModeSelectElement.addEventListener('change', (event) => {
            currentQuizMode = event.target.value;
            generateQuestion();
        });

        listeningModeToggleButton.addEventListener('click', () => {
            isListeningMode = !isListeningMode;
            updateUIText();
            generateQuestion();
        });

        const singleDigitReadings = { '1': '„ÅÑ„Å°', '2': '„Å´', '3': '„Åï„Çì', '4': '„Çà„Çì', '5': '„Åî', '6': '„Çç„Åè', '7': '„Å™„Å™', '8': '„ÅØ„Å°', '9': '„Åç„ÇÖ„ÅÜ', '0': '' };
        const singleDigitKanji = { '0': 'Èõ∂', '1': '‰∏Ä', '2': '‰∫å', '3': '‰∏â', '4': 'Âõõ', '5': '‰∫î', '6': 'ÂÖ≠', '7': '‰∏É', '8': 'ÂÖ´', '9': '‰πù' };

        function numToJapaneseSimple(num_to_convert) {
            if (num_to_convert === 0) return { kanji: "", reading: "" };
            if (num_to_convert > 9999 || num_to_convert < 0) { return {kanji: String(num_to_convert), reading: String(num_to_convert)}; }
            let n = num_to_convert; let k = ""; let r = "";
            if (n >= 1000) {
                const th = Math.floor(n / 1000);
                if (th === 1) { k += "ÂçÉ"; r += "„Åõ„Çì"; }
                else { k += (singleDigitKanji[String(th)] || String(th)) + "ÂçÉ";
                    if (th === 3) r += "„Åï„Çì„Åú„Çì"; else if (th === 8) r += "„ÅØ„Å£„Åõ„Çì";
                    else r += (singleDigitReadings[String(th)] || String(th)) + "„Åõ„Çì"; }
                n %= 1000;
            }
            if (n >= 100) {
                const h = Math.floor(n / 100);
                if (h === 1) { k += "Áôæ"; r += "„Å≤„ÇÉ„Åè"; }
                else { k += (singleDigitKanji[String(h)] || String(h)) + "Áôæ";
                    if (h === 3) r += "„Åï„Çì„Å≥„ÇÉ„Åè"; else if (h === 6) r += "„Çç„Å£„Å¥„ÇÉ„Åè"; else if (h === 8) r += "„ÅØ„Å£„Å¥„ÇÉ„Åè";
                    else r += (singleDigitReadings[String(h)] || String(h)) + "„Å≤„ÇÉ„Åè"; }
                n %= 100;
            }
            if (n >= 10) {
                const t = Math.floor(n / 10);
                if (t === 1) { k += "ÂçÅ"; r += "„Åò„ÇÖ„ÅÜ"; }
                else { k += (singleDigitKanji[String(t)] || String(t)) + "ÂçÅ";
                       r += (singleDigitReadings[String(t)] || String(t)) + "„Åò„ÇÖ„ÅÜ"; }
                n %= 10;
            }
            if (n > 0) { k += singleDigitKanji[String(n)] || String(n); r += singleDigitReadings[String(n)] || String(n); }
            return { kanji: k, reading: r };
        }

        function numToJapanese(num_orig) {
            if (num_orig === 0) return { kanji: "Èõ∂", reading: "„Çå„ÅÑ" };
            if (num_orig > 99999999 || num_orig < 0) { return {kanji: String(num_orig) + "(ËΩ¨Êç¢Ë∂ÖÂá∫ËåÉÂõ¥)", reading: String(num_orig) + "(ËΩ¨Êç¢Ë∂ÖÂá∫ËåÉÂõ¥)"}; }
            let num = num_orig; let k = ""; let r = "";
            if (num >= 10000) {
                const manVal = Math.floor(num / 10000); const manParts = numToJapaneseSimple(manVal);
                k += manParts.kanji + "‰∏á"; r += manParts.reading + "„Åæ„Çì";
                num %= 10000; if (num === 0) return { kanji: k, reading: r };
            }
            if (num > 0 || k === "") { const restParts = numToJapaneseSimple(num); k += restParts.kanji; r += restParts.reading; }
            if (k === "" && r === "" && num_orig > 0) { return {kanji: String(num_orig), reading: String(num_orig)}; }
            return { kanji: k, reading: r };
        }

        const allQuizData = [
            { type: 'standalone_number', unit: 'Áôæ', values: [ { num: 100, q: 'Áôæ', a: '„Å≤„ÇÉ„Åè' }, { num: 200, q: '‰∫åÁôæ', a: '„Å´„Å≤„ÇÉ„Åè' }, { num: 300, q: '‰∏âÁôæ', a: '„Åï„Çì„Å≥„ÇÉ„Åè' }, { num: 400, q: 'ÂõõÁôæ', a: '„Çà„Çì„Å≤„ÇÉ„Åè' }, { num: 500, q: '‰∫îÁôæ', a: '„Åî„Å≤„ÇÉ„Åè' }, { num: 600, q: 'ÂÖ≠Áôæ', a: '„Çç„Å£„Å¥„ÇÉ„Åè' }, { num: 700, q: '‰∏ÉÁôæ', a: '„Å™„Å™„Å≤„ÇÉ„Åè' }, { num: 800, q: 'ÂÖ´Áôæ', a: '„ÅØ„Å£„Å¥„ÇÉ„Åè' }, { num: 900, q: '‰πùÁôæ', a: '„Åç„ÇÖ„ÅÜ„Å≤„ÇÉ„Åè' } ]},
            { type: 'standalone_number', unit: 'ÂçÉ', values: [ { num: 1000, q: 'ÂçÉ', a: '„Åõ„Çì' }, { num: 2000, q: '‰∫åÂçÉ', a: '„Å´„Åõ„Çì' }, { num: 3000, q: '‰∏âÂçÉ', a: '„Åï„Çì„Åú„Çì' }, { num: 4000, q: 'ÂõõÂçÉ', a: '„Çà„Çì„Åõ„Çì' }, { num: 5000, q: '‰∫îÂçÉ', a: '„Åî„Åõ„Çì' }, { num: 6000, q: 'ÂÖ≠ÂçÉ', a: '„Çç„Åè„Åõ„Çì' }, { num: 7000, q: '‰∏ÉÂçÉ', a: '„Å™„Å™„Åõ„Çì' }, { num: 8000, q: 'ÂÖ´ÂçÉ', a: '„ÅØ„Å£„Åõ„Çì' }, { num: 9000, q: '‰πùÂçÉ', a: '„Åç„ÇÖ„ÅÜ„Åõ„Çì' } ]},
            { type: 'complex_number', displayName: 'Â§çÊùÇÊï∞Â≠ó', range: [101, 99999], generator: function() { let num; do { num = getRandomInt(this.range[0], this.range[1]); } while ( (num < 1000 && num % 100 === 0) || (num < 10000 && num % 1000 === 0) ); const jp = numToJapanese(num); return { q: String(num), a: jp.reading, kanji_representation: jp.kanji, original_number: num }; } },
            { type: 'number_counter_list', counterKanji: 'Êúà', items: [ { num: 1, numKanji: '‰∏Ä', qSuffix: 'Êúà', a: '„ÅÑ„Å°„Åå„Å§' }, { num: 2, numKanji: '‰∫å', qSuffix: 'Êúà', a: '„Å´„Åå„Å§' }, { num: 3, numKanji: '‰∏â', qSuffix: 'Êúà', a: '„Åï„Çì„Åå„Å§' }, { num: 4, numKanji: 'Âõõ', qSuffix: 'Êúà', a: '„Åó„Åå„Å§' }, { num: 5, numKanji: '‰∫î', qSuffix: 'Êúà', a: '„Åî„Åå„Å§' }, { num: 6, numKanji: 'ÂÖ≠', qSuffix: 'Êúà', a: '„Çç„Åè„Åå„Å§' }, { num: 7, numKanji: '‰∏É', qSuffix: 'Êúà', a: '„Åó„Å°„Åå„Å§' }, { num: 8, numKanji: 'ÂÖ´', qSuffix: 'Êúà', a: '„ÅØ„Å°„Åå„Å§' }, { num: 9, numKanji: '‰πù', qSuffix: 'Êúà', a: '„Åè„Åå„Å§' }, { num: 10, numKanji: 'ÂçÅ', qSuffix: 'Êúà', a: '„Åò„ÇÖ„ÅÜ„Åå„Å§' }, { num: 11, numKanji: 'ÂçÅ‰∏Ä', qSuffix: 'Êúà', a: '„Åò„ÇÖ„ÅÜ„ÅÑ„Å°„Åå„Å§' }, { num: 12, numKanji: 'ÂçÅ‰∫å', qSuffix: 'Êúà', a: '„Åò„ÇÖ„ÅÜ„Å´„Åå„Å§' } ]},
            { type: 'number_counter_list', counterKanji: 'Êó•', items: [ { num: 1, numKanji: '‰∏Ä', qSuffix: 'Êó•', a: '„Å§„ÅÑ„Åü„Å°' }, { num: 2, numKanji: '‰∫å', qSuffix: 'Êó•', a: '„Åµ„Å§„Åã' }, { num: 3, numKanji: '‰∏â', qSuffix: 'Êó•', a: '„Åø„Å£„Åã' }, { num: 4, numKanji: 'Âõõ', qSuffix: 'Êó•', a: '„Çà„Å£„Åã' }, { num: 5, numKanji: '‰∫î', qSuffix: 'Êó•', a: '„ÅÑ„Å§„Åã' }, { num: 6, numKanji: 'ÂÖ≠', qSuffix: 'Êó•', a: '„ÇÄ„ÅÑ„Åã' }, { num: 7, numKanji: '‰∏É', qSuffix: 'Êó•', a: '„Å™„ÅÆ„Åã' }, { num: 8, numKanji: 'ÂÖ´', qSuffix: 'Êó•', a: '„Çà„ÅÜ„Åã' }, { num: 9, numKanji: '‰πù', qSuffix: 'Êó•', a: '„Åì„Åì„ÅÆ„Åã' }, { num: 10, numKanji: 'ÂçÅ', qSuffix: 'Êó•', a: '„Å®„Åä„Åã' }, { num: 11, numKanji: 'ÂçÅ‰∏Ä', qSuffix: 'Êó•', a: '„Åò„ÇÖ„ÅÜ„ÅÑ„Å°„Å´„Å°'}, {num: 12, numKanji: 'ÂçÅ‰∫å', qSuffix: 'Êó•', a: '„Åò„ÇÖ„ÅÜ„Å´„Å´„Å°'}, { num: 13, numKanji: 'ÂçÅ‰∏â', qSuffix: 'Êó•', a: '„Åò„ÇÖ„ÅÜ„Åï„Çì„Å´„Å°'}, { num: 14, numKanji: 'ÂçÅÂõõ', qSuffix: 'Êó•', a: '„Åò„ÇÖ„ÅÜ„Çà„Å£„Åã' }, {num: 15, numKanji: 'ÂçÅ‰∫î', qSuffix: 'Êó•', a: '„Åò„ÇÖ„ÅÜ„Åî„Å´„Å°'}, { num: 16, numKanji: 'ÂçÅÂÖ≠', qSuffix: 'Êó•', a: '„Åò„ÇÖ„ÅÜ„Çç„Åè„Å´„Å°'}, {num: 17, numKanji: 'ÂçÅ‰∏É', qSuffix: 'Êó•', a: '„Åò„ÇÖ„ÅÜ„Åó„Å°„Å´„Å°'}, {num: 18, numKanji: 'ÂçÅÂÖ´', qSuffix: 'Êó•', a: '„Åò„ÇÖ„ÅÜ„ÅØ„Å°„Å´„Å°'}, {num: 19, numKanji: 'ÂçÅ‰πù', qSuffix: 'Êó•', a: '„Åò„ÇÖ„ÅÜ„Åè„Å´„Å°'}, { num: 20, numKanji: '‰∫åÂçÅ', qSuffix: 'Êó•', a: '„ÅØ„Å§„Åã' }, { num: 21, numKanji: '‰∫åÂçÅ‰∏Ä', qSuffix: 'Êó•', a: '„Å´„Åò„ÇÖ„ÅÜ„ÅÑ„Å°„Å´„Å°'}, { num: 24, numKanji: '‰∫åÂçÅÂõõ', qSuffix: 'Êó•', a: '„Å´„Åò„ÇÖ„ÅÜ„Çà„Å£„Åã' } ]},
            { type: 'number_counter_generated', counterKanji: 'ÊôÇ', range: [1, 12], generator: (num) => { const { kanji: k, reading: r } = numToJapaneseSimple(num); let a = ''; if (num === 4) a = '„Çà„Åò'; else if (num === 7) a = '„Åó„Å°„Åò'; else if (num === 9) a = '„Åè„Åò'; else a = r + '„Åò'; return { q: k + 'ÊôÇ', a: a, original_number: num }; }},
            { type: 'number_counter_generated', counterKanji: 'ÂàÜ', range: [1, 59], generator: (num) => { const { kanji: k, reading: r } = numToJapaneseSimple(num); let a = ''; const ld = num % 10; if (num === 1) a = '„ÅÑ„Å£„Å∑„Çì'; else if (num === 3 || (num > 10 && ld === 3)) a = r.slice(0, r.length - singleDigitReadings['3'].length) + '„Åï„Çì„Å∑„Çì'; else if (num === 4 || (num > 10 && ld === 4)) a = r.slice(0, r.length - singleDigitReadings['4'].length) + '„Çà„Çì„Å∑„Çì'; else if (num === 6 || (num > 10 && ld === 6)) a = r.slice(0, r.length - singleDigitReadings['6'].length) + '„Çç„Å£„Å∑„Çì'; else if (num === 8 || (num > 10 && ld === 8)) a = r.slice(0, r.length - singleDigitReadings['8'].length) + '„ÅØ„Å£„Å∑„Çì'; else if (num % 10 === 0) { if (num === 10) a = '„Åò„ÇÖ„Å£„Å∑„Çì'; else a = r.slice(0, -3) + '„Å£„Å∑„Çì'; } else if (num > 10 && ld === 1) a = r.slice(0, r.length - singleDigitReadings['1'].length) + '„ÅÑ„Å£„Å∑„Çì'; else a = r + '„Åµ„Çì'; if (num === 10) a = '„Åò„ÇÖ„Å£„Å∑„Çì'; if (num === 20) a = '„Å´„Åò„Å£„Å∑„Çì'; if (num === 30) a = '„Åï„Çì„Åò„Å£„Å∑„Çì'; if (num === 40) a = '„Çà„Çì„Åò„Å£„Å∑„Çì'; if (num === 50) a = '„Åî„Åò„Å£„Å∑„Çì'; return { q: k + 'ÂàÜ', a: a, original_number: num }; }},
            { type: 'number_counter_generated', counterKanji: 'Âõû', range: [1, 20], generator: (num) => { const { kanji: k, reading: r } = numToJapaneseSimple(num); let a = ''; if (num === 1) a = '„ÅÑ„Å£„Åã„ÅÑ'; else if (num === 6) a = '„Çç„Å£„Åã„ÅÑ'; else if (num === 8) a = '„ÅØ„Å£„Åã„ÅÑ'; else if (num === 10) a = '„Åò„Å£„Åã„ÅÑ'; else if (num > 10 && num % 10 === 1) a = r.slice(0, r.length - singleDigitReadings['1'].length) + '„ÅÑ„Å£„Åã„ÅÑ'; else if (num > 10 && num % 10 === 6) a = r.slice(0, r.length - singleDigitReadings['6'].length) + '„Çç„Å£„Åã„ÅÑ'; else if (num > 10 && num % 10 === 8) a = r.slice(0, r.length - singleDigitReadings['8'].length) + '„ÅØ„Å£„Åã„ÅÑ'; else if (num > 10 && num % 10 === 0) a = r.slice(0,-3) + '„Å£„Åã„ÅÑ'; else a = r + '„Åã„ÅÑ'; return { q: k + 'Âõû', a: a, original_number: num }; }},
            { type: 'number_counter_generated', counterKanji: 'ÂÜä', range: [1, 20], generator: (num) => { const { kanji: k, reading: r } = numToJapaneseSimple(num); let a = ''; if (num === 1) a = '„ÅÑ„Å£„Åï„Å§'; else if (num === 8) a = '„ÅØ„Å£„Åï„Å§'; else if (num === 10) a = '„Åò„Å£„Åï„Å§'; else if (num > 10 && num % 10 === 1) a = r.slice(0, r.length - singleDigitReadings['1'].length) + '„ÅÑ„Å£„Åï„Å§'; else if (num > 10 && num % 10 === 8) a = r.slice(0, r.length - singleDigitReadings['8'].length) + '„ÅØ„Å£„Åï„Å§'; else if (num > 10 && num % 10 === 0) a = r.slice(0,-3) + '„Å£„Åï„Å§'; else a = r + '„Åï„Å§'; return { q: k + 'ÂÜä', a: a, original_number: num }; }},
            { type: 'number_counter_generated', counterKanji: 'ÁùÄ', range: [1, 10], generator: (num) => { const { kanji: k, reading: r } = numToJapaneseSimple(num); let a = ''; if (num === 1) a = '„ÅÑ„Å£„Å°„ÇÉ„Åè'; else if (num === 8) a = '„ÅØ„Å£„Å°„ÇÉ„Åè'; else if (num === 10) a = '„Åò„Å£„Å°„ÇÉ„Åè'; else a = r + '„Å°„ÇÉ„Åè'; return { q: k + 'ÁùÄ', a: a, original_number: num }; }},
            { type: 'number_counter_generated', counterKanji: 'Êûö', range: [1, 20], generator: (num) => { const { kanji: k, reading: r } = numToJapaneseSimple(num); return { q: k + 'Êûö', a: r + '„Åæ„ÅÑ', original_number: num }; }},
            { type: 'number_counter_generated', counterKanji: '‰∫∫', range: [1, 10], generator: (num) => { const { kanji: k, reading: r } = numToJapaneseSimple(num); let a = ''; if (num === 1) a = '„Å≤„Å®„Çä'; else if (num === 2) a = '„Åµ„Åü„Çä'; else if (num === 4) a = '„Çà„Å´„Çì'; else a = r + '„Å´„Çì'; return { q: k + '‰∫∫', a: a, original_number: num }; }},
        ];

        const feedbackArea = document.getElementById('feedbackArea');
        const scoreDisplay = document.getElementById('score');

        let currentQuestionData = null;
        let score = 0;

        function getRandomInt(min, max) {
            min = Math.ceil(min); max = Math.floor(max);
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function generateQuestion() {
            answerInputElement.value = ''; feedbackArea.textContent = ''; feedbackArea.className = '';
            answerInputElement.disabled = true;
            checkButtonElement.disabled = true;
            playSoundButton.disabled = true;

            let filteredData = allQuizData;
            if (currentQuizMode === 'numbers') {
                filteredData = allQuizData.filter(item => item.type === 'standalone_number' || item.type === 'complex_number');
            } else if (currentQuizMode === 'counters') {
                filteredData = allQuizData.filter(item => item.type === 'number_counter_list' || item.type === 'number_counter_generated');
            }

            if (filteredData.length === 0) {
                console.warn("No data available for current quiz mode:", currentQuizMode, "Falling back to all data.");
                filteredData = allQuizData;
                if (allQuizData.length > 0) {
                    currentQuizMode = 'all';
                    quizModeSelectElement.value = 'all';
                } else {
                    questionArea.textContent = currentLanguage === 'zh' ? "Ê≤°ÊúâÂèØÁî®ÁöÑÈóÆÈ¢ò„ÄÇ" : "No questions available.";
                    return;
                }
            }
            updateUIText();

            const catIdx = getRandomInt(0, filteredData.length - 1); const cat = filteredData[catIdx];

            if (cat.type === 'standalone_number' || cat.type === 'number_counter_list') {
                const items = cat.values || cat.items; const itemIdx = getRandomInt(0, items.length - 1);
                currentQuestionData = { ...items[itemIdx], type: cat.type };
                 if (cat.type === 'number_counter_list') {
                    currentQuestionData.q = items[itemIdx].numKanji + items[itemIdx].qSuffix;
                }
                if (cat.type === 'standalone_number') {
                    currentQuestionData.original_number = items[itemIdx].num;
                }

            } else if (cat.type === 'number_counter_generated' || cat.type === 'complex_number') {
                const numGen = (cat.type === 'complex_number') ? null : getRandomInt(cat.range[0], cat.range[1]);
                currentQuestionData = cat.generator(numGen);
                currentQuestionData.type = cat.type;
            }

            if (isListeningMode) {
                questionArea.textContent = uiStrings[currentLanguage].listeningPrompt;
                questionArea.classList.add('listening-prompt');
                speak(currentQuestionData.a, () => {
                    answerInputElement.disabled = false;
                    checkButtonElement.disabled = false;
                    playSoundButton.disabled = false;
                    if (!isMuted) answerInputElement.focus();
                });
            } else {
                questionArea.textContent = currentQuestionData.q;
                questionArea.classList.remove('listening-prompt');
                answerInputElement.disabled = false;
                checkButtonElement.disabled = false;
                playSoundButton.disabled = true;
            }
        }

        function checkAnswer() {
            const userAnswer = answerInputElement.value.trim().replace(/„Çî/g, '„ÅÜ„Çõ');
            const strings = uiStrings[currentLanguage];

            if (!userAnswer) {
                feedbackArea.textContent = strings.inputPrompt; feedbackArea.className = 'incorrect';
                return;
            }

            let isCorrect = false;
            if (isListeningMode) {
                if (currentQuestionData.type === 'standalone_number' || currentQuestionData.type === 'complex_number') {
                    const arabicAnswer = currentQuestionData.original_number ? String(currentQuestionData.original_number) : currentQuestionData.q;
                    isCorrect = userAnswer === arabicAnswer || userAnswer === currentQuestionData.kanji_representation;
                } else {
                    isCorrect = userAnswer === currentQuestionData.q;
                }
            } else {
                isCorrect = userAnswer === currentQuestionData.a;
            }

            if (isCorrect) {
                feedbackArea.textContent = strings.correctFeedback;
                if (currentQuestionData.type === 'complex_number' && currentQuestionData.kanji_representation) {
                    feedbackArea.textContent += ` (${currentQuestionData.kanji_representation} / ${currentQuestionData.a})`;
                } else if (isListeningMode && (currentQuestionData.type === 'standalone_number' || currentQuestionData.type === 'complex_number')) {
                     feedbackArea.textContent += ` (${currentQuestionData.kanji_representation || currentQuestionData.q} / ${currentQuestionData.a})`;
                } else if (isListeningMode && (currentQuestionData.type === 'number_counter_list' || currentQuestionData.type === 'number_counter_generated')) {
                     feedbackArea.textContent += ` (${currentQuestionData.q} / ${currentQuestionData.a})`;
                } else {
                    if (currentQuestionData.kanji_representation && currentQuestionData.kanji_representation !== currentQuestionData.q) {
                         feedbackArea.textContent += ` (${currentQuestionData.kanji_representation})`;
                    }
                }
                feedbackArea.className = 'correct'; score++; scoreDisplay.textContent = score;
            } else {
                let correctAnswerDisplay = currentQuestionData.a;
                if (isListeningMode) {
                    if (currentQuestionData.type === 'standalone_number' || currentQuestionData.type === 'complex_number') {
                        correctAnswerDisplay = `${currentQuestionData.kanji_representation || currentQuestionData.q} (${currentQuestionData.a})`;
                    } else {
                        correctAnswerDisplay = `${currentQuestionData.q} (${currentQuestionData.a})`;
                    }
                } else {
                     correctAnswerDisplay = currentQuestionData.a;
                     if (currentQuestionData.kanji_representation && currentQuestionData.kanji_representation !== currentQuestionData.q) {
                         correctAnswerDisplay += ` (${currentQuestionData.kanji_representation})`;
                     } else if (!currentQuestionData.kanji_representation && currentQuestionData.type === 'complex_number'){
                         correctAnswerDisplay += ` (${currentQuestionData.q})`;
                     }
                }
                feedbackArea.textContent = `${strings.incorrectFeedbackPrefix}${correctAnswerDisplay}`;
                feedbackArea.className = 'incorrect';
            }
            answerInputElement.disabled = true; checkButtonElement.disabled = true;
            playSoundButton.disabled = false;
        }

        checkButtonElement.addEventListener('click', checkAnswer);
        nextButtonElement.addEventListener('click', generateQuestion);
        answerInputElement.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                if (!checkButtonElement.disabled) { checkAnswer(); }
                else { generateQuestion(); }
            }
        });

        initializeQuiz();
    </script>
</body>
</html>

